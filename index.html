<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Porori HUD</title>

<style>
html,body{ margin:0; padding:0; background:transparent; overflow:hidden; }
#widget{
  position:fixed; left:0; right:0; bottom:0;
  height:900px;
  pointer-events:none;
}

/* ===== ì™¼ìª½ THIS (2ë°°) ===== */
#leftWrap{
  position:absolute; left:16px; bottom:16px;
  transform-origin:left bottom;
  transform:scale(2);
  z-index:10;
}
#leftImg{ height:110px; width:auto; display:block; }

/* ===== ì¤‘ì•™ OW ê¶ ê²Œì´ì§€ (scale 2.25) ===== */
#center{
  position:absolute; left:50%; bottom:16px;
  height:110px; width:auto;
  transform-origin:center bottom;
  transform:translateX(-50%) scale(2.25);
  z-index:5;
  display:block;
}

/* ===== On.gif (ì¤‘ì•™ ìœ„) ===== */
#ultOn{
  position:absolute; left:50%; bottom:16px;
  transform:translateX(-50%);
  height:240px; width:auto;
  display:none;
  z-index:50;
  filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
}

/* ===== MENTAL ===== */
#mentalWrap{ position:absolute; left:120px; bottom:62px; z-index:999; }
#mentalLabel{
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 14px;
  letter-spacing: 1px;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
  margin: 0 0 4px 0;
  user-select: none;
  line-height: 1;
}
#mentalBar{
  display:flex; gap:3px;
  padding:5px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.30);
  backdrop-filter: blur(2px);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transform-origin:left top;
  transform: translate(-26px, 6px) scaleX(0.625);
}
.mentalSeg{
  width:10px; height:14px;
  border-radius:4px;
  background:#20d070;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
}
.mentalSeg.off{
  background:#f2f2f2;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}

/* =========================================================
   ğŸ¡ ë£°ë › ì˜¤ë²„ë ˆì´
   - íšŒì „ 30ì´ˆ
   - ê²°ê³¼ 30ì´ˆ ë³´ì—¬ì¤Œ
   - ì„œì„œíˆ ì‚¬ë¼ì§ (fade-out)
========================================================= */
#rouletteOverlay{
  position:absolute;
  inset:0;
  display:none;
  z-index:200;
  pointer-events:none;
  opacity:1;
  transition: opacity 2.0s ease; /* fade duration */
}
#rouletteOverlay.bg{
  background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.28), rgba(0,0,0,.12) 55%, rgba(0,0,0,0) 78%);
}

#rouletteWrap{
  position:absolute;
  left:50%;
  top:44%;
  transform:translate(-50%, -50%);
  width:460px;
  height:460px;
}

#rouletteTitle{
  position:absolute;
  left:50%;
  top:-64px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 28px;
  letter-spacing: 1px;
  color: rgba(255,255,255,.95);
  text-shadow: 0 10px 30px rgba(0,0,0,.55), 0 0 18px rgba(255,255,255,.25);
  white-space:nowrap;
}

#rouletteHint{
  position:absolute;
  left:50%;
  top:-28px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 800;
  font-size: 13px;
  letter-spacing: .6px;
  color: rgba(255,255,255,.85);
  text-shadow: 0 6px 18px rgba(0,0,0,.5);
  white-space:nowrap;
}

#rouletteCanvas{
  width:460px;
  height:460px;
  display:block;
  filter: drop-shadow(0 20px 55px rgba(0,0,0,.45));
}

/* í¬ì¸í„°(ìœ„ìª½) */
#roulettePointer{
  position:absolute;
  left:50%;
  top:-8px;
  transform:translateX(-50%);
  width:0; height:0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-bottom: 28px solid rgba(255,255,255,.95);
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.55));
}

/* ê²°ê³¼ ì¹´ë“œ */
#rouletteResult{
  position:absolute;
  left:50%;
  bottom:-84px;
  transform:translateX(-50%);
  min-width: 360px;
  padding: 14px 18px;
  border-radius: 16px;

  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: .5px;
  color: rgba(255,255,255,.95);
  text-align:center;

  background: linear-gradient(180deg, rgba(0,255,255,.18), rgba(255,0,200,.12));
  box-shadow: 0 18px 48px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.18);
  text-shadow: 0 10px 25px rgba(0,0,0,.55);
  display:none;
}

#rouletteGlow{
  position:absolute;
  inset:-30px;
  border-radius: 999px;
  background: radial-gradient(circle, rgba(0,255,255,.16), rgba(255,0,200,.10) 35%, rgba(0,0,0,0) 70%);
  filter: blur(2px);
  z-index:-1;
}
</style>
</head>

<body>
<div id="widget">

  <!-- ì™¼ìª½ THIS + MENTAL -->
  <div id="leftWrap">
    <img id="leftImg" src="./THIS.png" alt="THIS"/>
    <div id="mentalWrap">
      <div id="mentalLabel">MENTAL</div>
      <div id="mentalBar"></div>
    </div>
  </div>

  <!-- ì¤‘ì•™ OW ê²Œì´ì§€ -->
  <img id="center" src="./ow_thick_000.png" alt="Gauge"/>

  <!-- On.gif -->
  <img id="ultOn" src="./On.gif" alt="On"/>

  <!-- ğŸ¡ ë£°ë › ì˜¤ë²„ë ˆì´ -->
  <div id="rouletteOverlay" class="bg">
    <div id="rouletteWrap">
      <div id="rouletteGlow"></div>
      <div id="rouletteTitle">ë£°ë › START!</div>
      <div id="rouletteHint">30ì´ˆ íšŒì „ â†’ 30ì´ˆ ê²°ê³¼ í‘œì‹œ â†’ ì„œì„œíˆ ì‚¬ë¼ì§</div>
      <div id="roulettePointer"></div>
      <canvas id="rouletteCanvas" width="460" height="460"></canvas>
      <div id="rouletteResult"></div>
    </div>
  </div>

</div>

<script>
/* =========================================================
   âœ… OW ê¶ ë£¨í”„ (ìš”ì²­ ë°˜ì˜)
   - 0â†’100 (50ì´ˆ/ì¹¸)  âœ… ë³€ê²½ë¨
   - 100% ë„ë‹¬ í›„ 30ì´ˆ ë™ì•ˆ "100% ê²Œì´ì§€ë§Œ" í‘œì‹œ (On.gif ì—†ìŒ)
   - ê·¸ ì´í›„ On.gif 10ë¶„ ì¬ìƒ
   - ëë‚˜ë©´ 0%ë¡œ ë¦¬ì…‹ í›„ ë°˜ë³µ
   + On.gif ì‹œì‘ ìˆœê°„ ğŸ¡ ë£°ë › 30ì´ˆ ìŠ¤í•€
     â†’ ë‹¹ì²¨ ê²°ê³¼ 30ì´ˆ í‘œì‹œ
     â†’ fade-outìœ¼ë¡œ ì¢…ë£Œ
========================================================= */
const OW_INTERVAL_MS = 50_000;         // âœ… 50ì´ˆ/1%
const HOLD_100_MS    = 30_000;         // 100% ë„ë‹¬ í›„ 30ì´ˆ ìœ ì§€(í‘œê¸°)
const ON_DURATION_MS = 10 * 60 * 1000; // On.gif 10ë¶„

const centerImg = document.getElementById("center");
const ultOnImg  = document.getElementById("ultOn");

const pad3  = (n) => String(n).padStart(3,"0");
const owPath = (n) => `./ow_thick_${pad3(n)}.png`;

// preload
for (let i=0;i<=100;i++){
  const im = new Image();
  im.src = owPath(i);
}

let owValue = 0;
let chargingTimer = null;
let holdTimer = null;
let onTimer = null;

function setOW(n){
  owValue = Math.max(0, Math.min(100, n));
  centerImg.src = owPath(owValue) + "?v=" + Date.now();
}
function showOn(){
  ultOnImg.style.display = "block";
  ultOnImg.src = "./On.gif?v=" + Date.now(); // GIF ì¬ì‹œì‘
}
function hideOn(){ ultOnImg.style.display = "none"; }

function clearOWTimers(){
  if (chargingTimer){ clearInterval(chargingTimer); chargingTimer = null; }
  if (holdTimer){ clearTimeout(holdTimer); holdTimer = null; }
  if (onTimer){ clearTimeout(onTimer); onTimer = null; }
}

function startOWLoop(){
  clearOWTimers();

  owValue = 0;
  hideOn();
  setOW(0);

  chargingTimer = setInterval(() => {
    if (owValue < 100){
      setOW(owValue + 1);
    }

    if (owValue >= 100){
      clearInterval(chargingTimer);
      chargingTimer = null;

      // 100% ê²Œì´ì§€ë§Œ 30ì´ˆ ìœ ì§€
      holdTimer = setTimeout(() => {
        // On.gif ì‹œì‘
        showOn();

        // ğŸ¡ ë£°ë ›: On ì‹œì‘ ìˆœê°„ 30ì´ˆ ìŠ¤í•€ â†’ ê²°ê³¼ 30ì´ˆ â†’ í˜ì´ë“œì•„ì›ƒ
        startRouletteSpin();

        // 10ë¶„ í›„ ë¦¬ì…‹
        onTimer = setTimeout(() => {
          hideOn();
          stopRouletteIfRunning(); // í˜¹ì‹œ ë‚¨ì•„ìˆìœ¼ë©´ ì¢…ë£Œ
          startOWLoop();
        }, ON_DURATION_MS);

      }, HOLD_100_MS);
    }
  }, OW_INTERVAL_MS);
}

startOWLoop();

/* =========================================================
   MENTAL ê²Œì´ì§€
========================================================= */
const MENTAL_TOTAL = 20;
const MENTAL_INTERVAL_MS = 10 * 60 * 1000;
let mentalOn = MENTAL_TOTAL;

const mentalBar = document.getElementById("mentalBar");
const mentalSegs = [];

for (let i=0;i<MENTAL_TOTAL;i++){
  const seg = document.createElement("div");
  seg.className = "mentalSeg";
  mentalBar.appendChild(seg);
  mentalSegs.push(seg);
}

function getMentalColor(n){
  if (n >= 16) return "#20d070";
  if (n >= 12) return "#9BEA4A";
  if (n >= 8)  return "#D9B400";
  if (n >= 4)  return "#FF8A1E";
  return "#FF3B30";
}

function renderMental(){
  const c = getMentalColor(mentalOn);
  for (let i=0;i<MENTAL_TOTAL;i++){
    const on = i < mentalOn;
    mentalSegs[i].classList.toggle("off", !on);
    mentalSegs[i].style.backgroundColor = on ? c : "";
  }
}
function tickMental(){
  if (mentalOn > 0) mentalOn -= 1;
  else mentalOn = MENTAL_TOTAL;
  renderMental();
}
renderMental();
setInterval(tickMental, MENTAL_INTERVAL_MS);

/* =========================================================
   ğŸ¡ ë£°ë › (30ì´ˆ íšŒì „ í›„ ë©ˆì¶¤/ê²°ê³¼ 30ì´ˆ í‘œì‹œ/ì„œì„œíˆ ì‚¬ë¼ì§)
========================================================= */
const rouletteItems = [
  "ê³¨ë°˜ëŒ„ìŠ¤",
  "í¬ì¼“ëª¬ëŒ„ìŠ¤",
  "í„°ë¯¸ë„ëŒ„ìŠ¤",
  "ê´€ì œíƒ‘ ëŒ„ìŠ¤",
  "1ë¶„ê°„ ì• êµ íƒ€ì„",
  "ì‚¬ì¿ ë€ë³´ ëŒ„ìŠ¤",
];

const rouletteOverlay = document.getElementById("rouletteOverlay");
const rouletteCanvas  = document.getElementById("rouletteCanvas");
const rctx = rouletteCanvas.getContext("2d");
const rouletteResult = document.getElementById("rouletteResult");

const ROULETTE_SPIN_MS   = 30_000; // âœ… íšŒì „ 30ì´ˆ
const ROULETTE_SHOW_MS   = 30_000; // âœ… ê²°ê³¼ 30ì´ˆ í‘œì‹œ
const ROULETTE_FADE_MS   = 2_000;  // CSS transitionê³¼ ë§ì¶¤

let rouletteRAF = null;
let rouletteRunning = false;

let currentAngle = 0;
let targetAngle = 0;
let winnerIndex = 0;

let rouletteFadeTimer = null;
let rouletteHideTimer = null;

function pickWinner(){
  return Math.floor(Math.random() * rouletteItems.length);
}

function drawWheel(angle){
  const w = rouletteCanvas.width;
  const h = rouletteCanvas.height;
  const cx = w/2, cy = h/2;
  const R = Math.min(w,h)*0.43;

  rctx.clearRect(0,0,w,h);

  // ë°”ê¹¥ ê¸€ë¡œìš°
  const glow = rctx.createRadialGradient(cx,cy,R*0.2, cx,cy,R*1.15);
  glow.addColorStop(0, "rgba(0,255,255,0.18)");
  glow.addColorStop(0.5, "rgba(255,0,200,0.12)");
  glow.addColorStop(1, "rgba(0,0,0,0)");
  rctx.fillStyle = glow;
  rctx.beginPath();
  rctx.arc(cx,cy,R*1.15,0,Math.PI*2);
  rctx.fill();

  rctx.save();
  rctx.translate(cx,cy);
  rctx.rotate(angle);

  const n = rouletteItems.length;
  const slice = (Math.PI*2)/n;

  for (let i=0;i<n;i++){
    const a0 = i*slice;
    const a1 = a0 + slice;

    rctx.beginPath();
    rctx.moveTo(0,0);
    rctx.arc(0,0,R,a0,a1);
    rctx.closePath();
    rctx.fillStyle = (i%2===0) ? "rgba(0,255,255,0.22)" : "rgba(255,0,200,0.16)";
    rctx.fill();

    rctx.strokeStyle = "rgba(255,255,255,0.22)";
    rctx.lineWidth = 2;
    rctx.stroke();

    // í…ìŠ¤íŠ¸
    const mid = (a0+a1)/2;
    rctx.save();
    rctx.rotate(mid);
    rctx.translate(R*0.62, 0);
    rctx.rotate(Math.PI/2);
    rctx.font = "900 18px Arial";
    rctx.fillStyle = "rgba(255,255,255,0.95)";
    rctx.shadowColor = "rgba(0,0,0,0.55)";
    rctx.shadowBlur = 10;
    rctx.textAlign = "center";
    rctx.textBaseline = "middle";
    rctx.fillText(rouletteItems[i], 0, 0);
    rctx.restore();
  }

  // ì¤‘ì•™ ìº¡
  rctx.beginPath();
  rctx.arc(0,0,R*0.22,0,Math.PI*2);
  rctx.fillStyle = "rgba(10,10,14,0.70)";
  rctx.fill();
  rctx.strokeStyle = "rgba(255,255,255,0.22)";
  rctx.lineWidth = 2;
  rctx.stroke();

  rctx.font = "900 16px Arial";
  rctx.fillStyle = "rgba(255,255,255,0.92)";
  rctx.shadowColor = "rgba(0,0,0,0.55)";
  rctx.shadowBlur = 12;
  rctx.textAlign = "center";
  rctx.textBaseline = "middle";
  rctx.fillText("SPIN", 0, 0);

  rctx.restore();

  // ë°”ê¹¥ í…Œë‘ë¦¬
  rctx.beginPath();
  rctx.arc(cx,cy,R,0,Math.PI*2);
  rctx.strokeStyle = "rgba(255,255,255,0.26)";
  rctx.lineWidth = 3;
  rctx.stroke();
}

function easeOutCubic(x){
  return 1 - Math.pow(1-x, 3);
}

function startRouletteSpin(){
  stopRouletteIfRunning();

  rouletteOverlay.style.display = "block";
  rouletteOverlay.style.opacity = "1";   // âœ… ë‹¤ì‹œ ë³´ì´ê²Œ
  rouletteResult.style.display = "none";
  rouletteResult.textContent = "";

  rouletteRunning = true;
  const startAt = performance.now();

  winnerIndex = pickWinner();

  const n = rouletteItems.length;
  const slice = (Math.PI*2)/n;
  const winnerMid = (winnerIndex + 0.5) * slice;

  const baseTarget = -winnerMid;
  const extraTurns = 18 + Math.floor(Math.random()*6);
  const startAngle = currentAngle;
  targetAngle = baseTarget + extraTurns * Math.PI * 2;

  function tick(now){
    if (!rouletteRunning) return;

    const elapsed = now - startAt;
    const p = Math.min(1, elapsed / ROULETTE_SPIN_MS);
    const e = easeOutCubic(p);

    currentAngle = startAngle + (targetAngle - startAngle) * e;
    drawWheel(currentAngle);

    if (p >= 1){
      rouletteRunning = false;
      rouletteRAF = null;

      // ê²°ê³¼ í‘œì‹œ
      rouletteResult.textContent = `ë‹¹ì²¨: ${rouletteItems[winnerIndex]}`;
      rouletteResult.style.display = "block";

      // âœ… 30ì´ˆê°„ ê²°ê³¼ ë³´ì—¬ì¤€ ë’¤, ì„œì„œíˆ ì‚¬ë¼ì§
      rouletteFadeTimer = setTimeout(() => {
        rouletteOverlay.style.opacity = "0"; // fade-out ì‹œì‘
      }, ROULETTE_SHOW_MS);

      // fade ëë‚˜ë©´ display:none
      rouletteHideTimer = setTimeout(() => {
        rouletteOverlay.style.display = "none";
        rouletteOverlay.style.opacity = "1"; // ë‹¤ìŒ ì‚¬ìš© ëŒ€ë¹„ ë¦¬ì…‹
      }, ROULETTE_SHOW_MS + ROULETTE_FADE_MS);

      return;
    }

    rouletteRAF = requestAnimationFrame(tick);
  }

  drawWheel(currentAngle);
  rouletteRAF = requestAnimationFrame(tick);
}

function stopRouletteIfRunning(){
  if (rouletteRAF){
    cancelAnimationFrame(rouletteRAF);
    rouletteRAF = null;
  }
  rouletteRunning = false;

  if (rouletteFadeTimer){ clearTimeout(rouletteFadeTimer); rouletteFadeTimer = null; }
  if (rouletteHideTimer){ clearTimeout(rouletteHideTimer); rouletteHideTimer = null; }

  rouletteOverlay.style.display = "none";
  rouletteOverlay.style.opacity = "1";
  rouletteResult.style.display = "none";
}
</script>
</body>
</html>
