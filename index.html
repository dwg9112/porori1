<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Porori HUD</title>

<style>
html,body{ margin:0; padding:0; background:transparent; overflow:hidden; }
#widget{
  position:fixed; left:0; right:0; bottom:0;
  height:900px;
  pointer-events:none;
}

/* ===== ì™¼ìª½ THIS (2ë°°) ===== */
#leftWrap{
  position:absolute; left:16px; bottom:16px;
  transform-origin:left bottom;
  transform:scale(2);
  z-index:10;
}
#leftImg{ height:110px; width:auto; display:block; }

/* ===== ì¤‘ì•™ OW ê¶ ê²Œì´ì§€ (scale 2.25) ===== */
#center{
  position:absolute; left:50%; bottom:16px;
  height:110px; width:auto;
  transform-origin:center bottom;
  transform:translateX(-50%) scale(2.25);
  z-index:5;
  display:block;
}

/* ===== On.gif (ì¤‘ì•™ ìœ„) ===== */
#ultOn{
  position:absolute; left:50%; bottom:16px;
  transform:translateX(-50%);
  height:240px; width:auto;
  display:none;
  z-index:50;
  filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
}

/* ===== MENTAL ===== */
#mentalWrap{ position:absolute; left:120px; bottom:62px; z-index:999; }
#mentalLabel{
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 14px;
  letter-spacing: 1px;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
  margin: 0 0 4px 0;
  user-select: none;
  line-height: 1;
}
#mentalBar{
  display:flex; gap:3px;
  padding:5px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.30);
  backdrop-filter: blur(2px);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transform-origin:left top;
  transform: translate(-26px, 6px) scaleX(0.625);
}
.mentalSeg{
  width:10px; height:14px;
  border-radius:4px;
  background:#20d070;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
}
.mentalSeg.off{
  background:#f2f2f2;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}

/* =========================================================
   ğŸ° ë ˆë²„ ì˜¤ë²„ë ˆì´
========================================================= */
#rouletteOverlay{
  position:absolute;
  inset:0;
  display:none;
  z-index:200;
  pointer-events:none;
  opacity:1;
  transition: opacity 2.0s ease;
}
#rouletteOverlay.bg{
  background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.28), rgba(0,0,0,.12) 55%, rgba(0,0,0,0) 78%);
}

#rouletteWrap{
  position:absolute;
  left:50%;
  top:44%;
  transform:translate(-50%, -50%);
  width:560px;
  height:560px;
}

#rouletteGlow{
  position:absolute;
  inset:-40px;
  border-radius: 999px;
  background: radial-gradient(circle, rgba(255,255,255,.12), rgba(0,0,0,0) 70%);
  filter: blur(2px);
  z-index:-1;
}

/* âœ… íƒ€ì´í‹€: "ë£°ë ›" ê²€ì • / "START!" ì´ˆë¡ / "ë‹¹ê²¨ìš”!" ë¹¨ê°• */
#rouletteTitle{
  position:absolute;
  left:50%;
  top:-78px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 38px;
  letter-spacing: 1px;
  color: rgba(255,255,255,.95);
  text-shadow: 0 10px 30px rgba(0,0,0,.55), 0 0 18px rgba(255,255,255,.18);
  white-space:nowrap;
  display:flex;
  align-items:baseline;
  gap:12px;
}
#rouletteTitle .r{
  color: rgba(0,0,0,.88); /* ë£°ë ›: ê²€ì • */
  text-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 10px rgba(255,255,255,.12);
}
#rouletteTitle .s{
  color: #23e06b; /* START!: ì´ˆë¡ */
  text-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 16px rgba(35,224,107,.35);
}

#rouletteSub{
  position:absolute;
  left:50%;
  top:-24px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 26px;
  letter-spacing: 1px;
  color: #ff3b30; /* ë‹¹ê²¨ìš”!: ë¹¨ê°• */
  text-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 18px rgba(255,59,48,.25);
  white-space:nowrap;
}

/* =========================
   ğŸ° ì•„ì¼€ì´ë“œ ë ˆë²„ ë¨¸ì‹ (ë” ê²Œì„ì¥ ëŠë‚Œ)
========================= */
#leverMachine{
  width:560px;
  height:560px;
  position:relative;
}

/* ë³¸ì²´ */
#arcadeCabinet{
  position:absolute;
  left:50%;
  top:54%;
  transform:translate(-50%,-50%);
  width:520px;
  height:360px;
  border-radius: 28px;
  background:
    radial-gradient(circle at 35% 20%, rgba(255,255,255,.22), rgba(255,255,255,0) 55%),
    linear-gradient(to bottom, rgba(30,30,30,.92), rgba(10,10,10,.92));
  box-shadow:
    0 30px 80px rgba(0,0,0,.55),
    inset 0 0 0 2px rgba(255,255,255,.10),
    inset 0 0 0 10px rgba(0,0,0,.25);
  overflow:hidden;
}

#arcadeBezel{
  position:absolute;
  inset:18px;
  border-radius: 22px;
  background:
    linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,0)),
    rgba(0,0,0,.28);
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,.10),
    inset 0 0 0 10px rgba(0,0,0,.22);
}

/* ë¦´(ê¸€ì”¨ ëŒì•„ê°€ëŠ” ì°½) */
#reelWindow{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-55%,-50%);
  width:320px;
  height:140px;
  border-radius: 18px;
  background: rgba(0,0,0,.55);
  box-shadow:
    0 18px 45px rgba(0,0,0,.45),
    inset 0 0 0 2px rgba(255,255,255,.14),
    inset 0 0 0 10px rgba(0,0,0,.28);
  overflow:hidden;
}

#reelScanline{
  position:absolute;
  inset:0;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,.05) 0px,
    rgba(255,255,255,.05) 2px,
    rgba(0,0,0,0) 6px,
    rgba(0,0,0,0) 12px
  );
  mix-blend-mode: overlay;
  opacity:.25;
  pointer-events:none;
}

#reelHighlight{
  position:absolute;
  left:12px; right:12px;
  top:50%;
  transform:translateY(-50%);
  height:56px;
  border-radius: 14px;
  box-shadow:
    inset 0 0 0 2px rgba(35,224,107,.35),
    0 0 18px rgba(35,224,107,.22);
  background: linear-gradient(to bottom, rgba(35,224,107,.10), rgba(0,0,0,0));
  pointer-events:none;
}

#reelClip{
  position:absolute;
  inset:14px;
  border-radius: 14px;
  overflow:hidden;
}

#reelInner{
  position:absolute;
  left:0; top:0; right:0;
  will-change: transform;
}

.reelItem{
  height:56px;               /* ê³ ì • ë†’ì´ (JSì—ì„œë„ ì‚¬ìš©) */
  display:flex;
  align-items:center;
  justify-content:center;
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 34px;
  letter-spacing: 1px;
  color: rgba(255,255,255,.96);
  text-shadow: 0 12px 28px rgba(0,0,0,.65);
  white-space:nowrap;
}

/* ì¥ì‹ ë¼ì´íŠ¸ */
#sideLights{
  position:absolute;
  left:16px;
  top:20px;
  bottom:20px;
  width:42px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  opacity:.95;
}
.lightDot{
  width:18px; height:18px;
  border-radius:999px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.15) 45%, rgba(0,0,0,.35) 100%);
  box-shadow: 0 10px 20px rgba(0,0,0,.35), 0 0 18px rgba(35,224,107,.14);
  margin-left:10px;
  animation: blink 1.6s infinite ease-in-out;
}
.lightDot:nth-child(2){ animation-delay:.2s; }
.lightDot:nth-child(3){ animation-delay:.4s; }
.lightDot:nth-child(4){ animation-delay:.6s; }
.lightDot:nth-child(5){ animation-delay:.8s; }
.lightDot:nth-child(6){ animation-delay:1.0s; }
.lightDot:nth-child(7){ animation-delay:1.2s; }
.lightDot:nth-child(8){ animation-delay:1.4s; }

@keyframes blink{
  0%,100%{ filter:brightness(1); opacity:.85; }
  50%{ filter:brightness(1.35); opacity:1; }
}

/* ë ˆë²„(ë” ì´ì˜ê²Œ) */
#leverAssembly{
  position:absolute;
  right:34px;
  top:50%;
  transform:translateY(-50%);
  width:110px;
  height:300px;
  filter: drop-shadow(0 18px 28px rgba(0,0,0,.45));
}
#leverTrack{
  position:absolute;
  left:50%;
  top:18px;
  transform:translateX(-50%);
  width:28px;
  height:264px;
  border-radius: 999px;
  background:
    linear-gradient(to bottom, rgba(255,255,255,.25), rgba(255,255,255,.04)),
    rgba(0,0,0,.25);
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,.10),
    inset 0 0 0 10px rgba(0,0,0,.20);
}

#leverRod{
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  width:60px;
  height:300px;
  transform-origin: 50% 0%;
}
#leverRod::before{
  content:"";
  position:absolute;
  left:50%;
  top:28px;
  transform:translateX(-50%);
  width:12px;
  height:210px;
  border-radius: 999px;
  background: linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,.18));
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
}
#leverKnob{
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  width:52px;
  height:52px;
  border-radius:999px;
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,.18) 35%, rgba(0,0,0,.30) 100%),
    radial-gradient(circle at 60% 70%, rgba(255,59,48,.65), rgba(255,59,48,0) 62%);
  box-shadow: 0 16px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.22);
}

/* âœ… 10ì´ˆ í›„ 1ì´ˆ ë™ì•ˆ ë‚´ë ¤ê° */
@keyframes leverPullDown {
  0%   { transform: translateX(-50%) translateY(0) rotate(0deg); }
  65%  { transform: translateX(-50%) translateY(170px) rotate(10deg); }
  100% { transform: translateX(-50%) translateY(170px) rotate(10deg); }
}
@keyframes leverReturnUp {
  0%   { transform: translateX(-50%) translateY(170px) rotate(10deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
}
#leverRod.pullDown{ animation: leverPullDown 1000ms cubic-bezier(.2,.9,.2,1) forwards; }
#leverRod.returnUp{ animation: leverReturnUp 520ms cubic-bezier(.2,.8,.2,1) forwards; }

/* í­ì£½(ì–‘ì˜†) */
.fireworks{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:240px;
  height:240px;
  pointer-events:none;
  display:none;
  z-index:5;
}
#fwLeft{ left:-40px; }
#fwRight{ right:-40px; }

.particle{
  position:absolute;
  left:50%; top:50%;
  width:10px; height:10px;
  border-radius:999px;
  transform:translate(-50%,-50%);
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.2) 45%, rgba(0,0,0,.25) 100%);
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
  opacity:0;
}

@keyframes burst {
  0%   { transform:translate(-50%,-50%) scale(0.6); opacity:0; }
  10%  { opacity:1; }
  100% { transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1); opacity:0; }
}

/* íŒ */
@keyframes divaPop {
  0%   { transform:translate(-50%, -50%) scale(1); }
  35%  { transform:translate(-50%, -50%) scale(1.02); }
  70%  { transform:translate(-50%, -50%) scale(0.995); }
  100% { transform:translate(-50%, -50%) scale(1); }
}
#rouletteWrap.pop { animation: divaPop 600ms ease; }
</style>
</head>

<body>
<div id="widget">

  <!-- ì™¼ìª½ THIS + MENTAL -->
  <div id="leftWrap">
    <img id="leftImg" src="./THIS.png" alt="THIS"/>
    <div id="mentalWrap">
      <div id="mentalLabel">MENTAL</div>
      <div id="mentalBar"></div>
    </div>
  </div>

  <!-- ì¤‘ì•™ OW ê²Œì´ì§€ -->
  <img id="center" src="./ow_thick_000.png" alt="Gauge"/>

  <!-- On.gif -->
  <img id="ultOn" src="./On.gif" alt="On"/>

  <!-- ğŸ° ë ˆë²„ ì˜¤ë²„ë ˆì´ -->
  <div id="rouletteOverlay" class="bg">
    <div id="rouletteWrap">
      <div id="rouletteGlow"></div>

      <div id="rouletteTitle">
        <span class="r">ë£°ë ›</span>
        <span class="s">START!</span>
      </div>
      <div id="rouletteSub">ë‹¹ê²¨ìš”!</div>

      <div id="leverMachine">
        <!-- í­ì£½ -->
        <div id="fwLeft" class="fireworks"></div>
        <div id="fwRight" class="fireworks"></div>

        <!-- ë³¸ì²´ -->
        <div id="arcadeCabinet">
          <div id="arcadeBezel"></div>

          <div id="sideLights" aria-hidden="true">
            <div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div>
            <div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div>
          </div>

          <!-- ë¦´ ì°½ -->
          <div id="reelWindow">
            <div id="reelClip">
              <div id="reelInner"></div>
            </div>
            <div id="reelHighlight"></div>
            <div id="reelScanline"></div>
          </div>

          <!-- ë ˆë²„ -->
          <div id="leverAssembly">
            <div id="leverTrack"></div>
            <div id="leverRod">
              <div id="leverKnob"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<script>
/* =========================================================
   ğŸ”Š "D.Va ëŠë‚Œ" ì—¬ì„± TTS
========================================================= */
let divaVoice = null;

function chooseDivaVoice(){
  if (!("speechSynthesis" in window)) return null;
  const voices = window.speechSynthesis.getVoices();

  let v =
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko") && /(female|woman|girl)/i.test(x.name)) ||
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko") && /(ì—¬|ì—¬ì„±|ì†Œë…€|yuna|sora|seo|ji)/i.test(x.name)) ||
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko")) ||
    voices.find(x => /(female|woman|girl)/i.test(x.name)) ||
    null;

  return v || null;
}

function ensureVoiceReady(){
  try{
    if (!("speechSynthesis" in window)) return;
    const tryPick = () => { divaVoice = chooseDivaVoice(); };
    tryPick();
    if (!divaVoice){
      window.speechSynthesis.onvoiceschanged = () => {
        divaVoice = chooseDivaVoice();
      };
    }
  }catch(e){}
}
ensureVoiceReady();

function speakDiva(text){
  try{
    if (!("speechSynthesis" in window)) return;
    const synth = window.speechSynthesis;
    synth.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ko-KR";
    u.rate = 1.18;
    u.pitch = 1.45;
    u.volume = 1.0;

    if (!divaVoice) divaVoice = chooseDivaVoice();
    if (divaVoice) u.voice = divaVoice;

    synth.speak(u);
  }catch(e){}
}

/* =========================================================
   ğŸµ ìŠ¬ë¡¯ ë ˆë²„ "ë”¸ê¹ë”¸ê¹" ì‚¬ìš´ë“œ (WebAudio)
   - ìµœì´ˆ 1íšŒ ì‚¬ìš©ì ì œìŠ¤ì²˜ ì—†ìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ì†Œë¦¬ë¥¼ ë§‰ì„ ìˆ˜ ìˆìŒ
========================================================= */
let audioCtx = null;

function getAudioCtx(){
  if (!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    audioCtx = new AC();
  }
  return audioCtx;
}

function unlockAudio(){
  const ctx = getAudioCtx();
  if (!ctx) return;
  if (ctx.state === "suspended"){
    ctx.resume().catch(()=>{});
  }
}
window.addEventListener("pointerdown", unlockAudio, { once:true });
window.addEventListener("keydown", unlockAudio, { once:true });

function clickSound({ t=0, pitch=900, dur=0.035, gain=0.22 } = {}){
  const ctx = getAudioCtx();
  if (!ctx) return;
  if (ctx.state === "suspended") return;

  const now = ctx.currentTime + t;

  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type = "square";
  o.frequency.setValueAtTime(pitch, now);
  o.frequency.exponentialRampToValueAtTime(Math.max(80, pitch*0.65), now + dur);

  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(gain, now + 0.003);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

  o.connect(g).connect(ctx.destination);
  o.start(now);
  o.stop(now + dur);

  // ì•„ì£¼ ì§§ì€ ë…¸ì´ì¦ˆ(ë”±!)
  const bufferSize = Math.floor(ctx.sampleRate * 0.02);
  const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++){
    const decay = Math.exp(-i / (bufferSize * 0.18));
    data[i] = (Math.random()*2 - 1) * 0.22 * decay;
  }
  const noise = ctx.createBufferSource();
  const ng = ctx.createGain();
  noise.buffer = buffer;
  ng.gain.setValueAtTime(0.0001, now);
  ng.gain.exponentialRampToValueAtTime(gain*0.55, now + 0.001);
  ng.gain.exponentialRampToValueAtTime(0.0001, now + 0.02);
  noise.connect(ng).connect(ctx.destination);
  noise.start(now);
}

function leverClickPattern(){
  // ë‹¹ê¸¸ ë•Œ: ë”¸ê¹ë”¸ê¹
  clickSound({ t: 0.00, pitch: 1050, gain: 0.18, dur: 0.030 });
  clickSound({ t: 0.12, pitch: 980,  gain: 0.17, dur: 0.030 });
  clickSound({ t: 0.24, pitch: 900,  gain: 0.17, dur: 0.032 });
  // ë‚´ë ¤ê°ˆ ë•Œ í° ë”¸ê¹
  clickSound({ t: 0.62, pitch: 720,  gain: 0.26, dur: 0.048 });
  // ëŒì•„ì˜¤ë©° ì‘ì€ ë”¸ê¹
  clickSound({ t: 0.92, pitch: 860,  gain: 0.14, dur: 0.028 });
}

/* =========================================================
   âœ… OW ê¶ ë£¨í”„
   - 0â†’100 (50ì´ˆ/ì¹¸)
   - 100% ë„ë‹¬ í›„ 30ì´ˆ ë™ì•ˆ "100% ê²Œì´ì§€ë§Œ" í‘œì‹œ
   - ê·¸ ì´í›„ On.gif 10ë¶„ ì¬ìƒ
   - ëë‚˜ë©´ 0%ë¡œ ë¦¬ì…‹ í›„ ë°˜ë³µ
   + âœ… ê²¹ì¹¨ ë°©ì§€: On.gif ì‹œì‘ ì§ì „ì— ê²Œì´ì§€ ìˆ¨ê¹€
========================================================= */
const OW_INTERVAL_MS = 1_000;
const HOLD_100_MS    = 30_000;
const ON_DURATION_MS = 10 * 60 * 1000;

const centerImg = document.getElementById("center");
const ultOnImg  = document.getElementById("ultOn");

const pad3  = (n) => String(n).padStart(3,"0");
const owPath = (n) => `./ow_thick_${pad3(n)}.png`;

for (let i=0;i<=100;i++){
  const im = new Image();
  im.src = owPath(i);
}

let owValue = 0;
let chargingTimer = null;
let holdTimer = null;
let onTimer = null;

function setOW(n){
  owValue = Math.max(0, Math.min(100, n));
  centerImg.src = owPath(owValue) + "?v=" + Date.now();
}
function showOn(){
  ultOnImg.style.display = "block";
  ultOnImg.src = "./On.gif?v=" + Date.now();
}
function hideOn(){ ultOnImg.style.display = "none"; }

function clearOWTimers(){
  if (chargingTimer){ clearInterval(chargingTimer); chargingTimer = null; }
  if (holdTimer){ clearTimeout(holdTimer); holdTimer = null; }
  if (onTimer){ clearTimeout(onTimer); onTimer = null; }
}

function startOWLoop(){
  clearOWTimers();
  owValue = 0;
  hideOn();
  centerImg.style.visibility = "visible"; // ì•ˆì „
  setOW(0);

  chargingTimer = setInterval(() => {
    if (owValue < 100) setOW(owValue + 1);

    if (owValue >= 100){
      clearInterval(chargingTimer);
      chargingTimer = null;

      holdTimer = setTimeout(() => {
        // âœ… 100% ê²Œì´ì§€ì™€ On.gif ê²¹ì¹¨ ë°©ì§€
        centerImg.style.visibility = "hidden";

        showOn();
        startRouletteSpin();

        onTimer = setTimeout(() => {
          hideOn();
          stopRouletteIfRunning();
          centerImg.style.visibility = "visible";
          startOWLoop();
        }, ON_DURATION_MS);

      }, HOLD_100_MS);
    }
  }, OW_INTERVAL_MS);
}
startOWLoop();

/* =========================================================
   MENTAL ê²Œì´ì§€
========================================================= */
const MENTAL_TOTAL = 20;
const MENTAL_INTERVAL_MS = 10 * 60 * 1000;
let mentalOn = MENTAL_TOTAL;

const mentalBar = document.getElementById("mentalBar");
const mentalSegs = [];
for (let i=0;i<MENTAL_TOTAL;i++){
  const seg = document.createElement("div");
  seg.className = "mentalSeg";
  mentalBar.appendChild(seg);
  mentalSegs.push(seg);
}

function getMentalColor(n){
  if (n >= 16) return "#20d070";
  if (n >= 12) return "#9BEA4A";
  if (n >= 8)  return "#D9B400";
  if (n >= 4)  return "#FF8A1E";
  return "#FF3B30";
}
function renderMental(){
  const c = getMentalColor(mentalOn);
  for (let i=0;i<MENTAL_TOTAL;i++){
    const on = i < mentalOn;
    mentalSegs[i].classList.toggle("off", !on);
    mentalSegs[i].style.backgroundColor = on ? c : "";
  }
}
function tickMental(){
  if (mentalOn > 0) mentalOn -= 1;
  else mentalOn = MENTAL_TOTAL;
  renderMental();
}
renderMental();
setInterval(tickMental, MENTAL_INTERVAL_MS);

/* =========================================================
   ğŸ° ë ˆë²„ + ë¦´(í…ìŠ¤íŠ¸) ì—°ì¶œ ìš”êµ¬ì‚¬í•­
   - ì˜¤ë²„ë ˆì´ ëœ¨ê³  10ì´ˆ í›„
   - 1ì´ˆ ë™ì•ˆ ë ˆë²„ ë‚´ë ¤ê°
   - ë ˆë²„ ë‚´ë ¤ê°€ë©´ ë¦´ í…ìŠ¤íŠ¸ê°€ ì•„ë˜ë¡œ 30ì´ˆ ë™ì•ˆ íšŒì „
   - ë‹¹ì²¨ í™•ì • ìˆœê°„: í­ì£½(ì–‘ì˜†)
   - "ë‹¹ì²¨ ë°•ìŠ¤" ì œê±°(ì•„ì˜ˆ ì—†ìŒ)
========================================================= */
const rouletteItems = [
  "ê³¨ë°˜ëŒ„ìŠ¤",
  "í¬ì¼“ëª¬ëŒ„ìŠ¤",
  "í„°ë¯¸ë„ëŒ„ìŠ¤",
  "ê´€ì œíƒ‘ëŒ„ìŠ¤",
  "ì• êµ íƒ€ì„",
  "ì‚¬ì¿ ë€ë³´ëŒ„ìŠ¤",
];

const rouletteOverlay = document.getElementById("rouletteOverlay");
const rouletteWrap = document.getElementById("rouletteWrap");

const leverRod = document.getElementById("leverRod");

const reelInner = document.getElementById("reelInner");
const fwLeft = document.getElementById("fwLeft");
const fwRight = document.getElementById("fwRight");

const WAIT_BEFORE_PULL_MS = 10_000;
const LEVER_PULL_MS = 1_000;
const REEL_SPIN_MS = 30_000;

const OVERLAY_SHOW_AFTER_WIN_MS = 2_000; // í­ì£½ ë³´ì—¬ì£¼ëŠ” ì‹œê°„(ì§§ê²Œ)
const FADE_AFTER_WIN_MS = 2_000;         // í˜ì´ë“œ ì‹œê°„
const ITEM_H = 56;                       // .reelItem heightì™€ ë™ì¼í•´ì•¼ í•¨

let startDelayTimer = null;
let leverReturnTimer = null;
let winFadeTimer = null;
let winHideTimer = null;

let reelRAF = null;
let reelRunning = false;

let currentOffset = 0;
let cycleH = 0;

function buildReel(){
  // ì¶©ë¶„íˆ ê¸¸ê²Œ ë°˜ë³µ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°
  const repeats = 18;
  const all = [];
  for (let r=0;r<repeats;r++){
    for (let i=0;i<rouletteItems.length;i++){
      all.push(rouletteItems[i]);
    }
  }
  reelInner.innerHTML = all.map(t => `<div class="reelItem">${t}</div>`).join("");
  cycleH = rouletteItems.length * ITEM_H;
  currentOffset = 0;
  reelInner.style.transform = `translateY(${currentOffset}px)`;
}
buildReel();

function pickWinner(){
  return Math.floor(Math.random() * rouletteItems.length);
}

function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

function startReelSpinAndStopOn(winnerIndex){
  // ë¦´ì€ "ì•„ë˜ë¡œ" íšŒì „(translateY ì¦ê°€í•˜ë©´ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ì„œ ìœ„ìª½ì´ ë³´ì„ â†’ ë°˜ëŒ€ë¡œë¼ í—·ê°ˆë¦´ ìˆ˜ ìˆìŒ)
  // ì—¬ê¸°ì„  ì•„ë˜ë¡œ íë¥´ëŠ” ëŠë‚Œì„ ìœ„í•´ offsetì„ "ë§ˆì´ë„ˆìŠ¤"ë¡œ ê³„ì† ì¤„ì—¬ì„œ(ìœ„ë¡œ ì˜¬ë ¤ì„œ) ê¸€ìê°€ ì•„ë˜ë¡œ ì§€ë‚˜ê°€ê²Œ ë³´ì´ê²Œ í•¨.
  // (ë¦´ ì•ˆì˜ ì»¨í…ì¸ ê°€ ìœ„ë¡œ ì´ë™í•˜ë©´ ì°½ì—ì„œëŠ” í…ìŠ¤íŠ¸ê°€ ì•„ë˜ë¡œ ë‚´ë ¤ì˜¤ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì„)
  if (reelRAF) cancelAnimationFrame(reelRAF);
  reelRunning = true;

  const startAt = performance.now();
  const startOffset = currentOffset;

  // ì†ë„: 30ì´ˆ ë™ì•ˆ ìì—°ìŠ¤ëŸ½ê²Œ ì¶©ë¶„íˆ ë§ì´ ëŒê²Œ
  const speed = 1600; // px/sec (ì›í•˜ë©´ ë” ì˜¬ë ¤ë„ ë¨)

  // ë§ˆì§€ë§‰ 1.2ì´ˆëŠ” ê°ì†í•´ì„œ winnerì— ë§ì¶”ê¸°
  const settleMs = 1200;
  const spinMs = Math.max(0, REEL_SPIN_MS - settleMs);

  // winnerë¥¼ ì¤‘ì•™ í•˜ì´ë¼ì´íŠ¸(ì°½ ì¤‘ì•™)ì— ë§ì¶”ê¸° ìœ„í•œ ëª©í‘œ offset ê³„ì‚°
  // reelClip inset(14px) + window ì•ˆì—ì„œ ì¤‘ì•™ì€ ëŒ€ëµ 14 + (140-28)/2 = 70 ê·¼ì²˜.
  // í•˜ì§€ë§Œ item ìì²´ê°€ 56px ê³ ì •ì´ë‹ˆ, "ì •í™•í•œ ì¤‘ì•™"ì€ ê°ê°ì ìœ¼ë¡œ ë§ì¶”ê¸° ìœ„í•´ 42px ë³´ì •.
  const centerY = 42; // ê°ê° ë³´ì •ì¹˜(í•„ìš”í•˜ë©´ 38~46 ì‚¬ì´ë¡œ ì¡°ì ˆ)
  const targetInCycle = winnerIndex * ITEM_H; // cycleì—ì„œ winnerê°€ ì‹œì‘í•˜ëŠ” ìœ„ì¹˜
  // currentOffsetì„ cycleë¡œ ì •ê·œí™”í•œ ë’¤, targetìœ¼ë¡œ ì´ë™
  const normalized = ((-startOffset % cycleH) + cycleH) % cycleH; // 0..cycleH
  // ëª©í‘œ: (-offset) % cycleH == targetInCycle - centerY (mod)
  // => offset == -(targetInCycle - centerY) (mod cycleH)
  let desired = - (targetInCycle - centerY);
  // desiredì™€ ê°™ì€ í´ë˜ìŠ¤ì—ì„œ, í˜„ì¬ offsetë³´ë‹¤ ì¶©ë¶„íˆ ë” íšŒì „í•˜ë„ë¡(ë” ìŒìˆ˜ë¡œ)
  // spin ë™ì•ˆ offsetì€ ê³„ì† ê°ì†Œ(ë” ìŒìˆ˜)í•˜ë‹ˆ, desiredë³´ë‹¤ ë” ì‘ì€(ìŒìˆ˜ ë” í° ì ˆëŒ“ê°’) ê°’ì„ ì„ íƒ
  while (desired > startOffset - 2000) {
    desired -= cycleH;
  }
  // í•œ ë²ˆ ë” í¬ê²Œ ëŒë ¤ì„œ â€œì§„ì§œ ëŒì•„ê°€ë‹¤ ë©ˆì¶¤â€ ëŠë‚Œ
  desired -= cycleH * 6;

  const settleStartAt = startAt + spinMs;

  function tick(now){
    if (!reelRunning) return;

    if (now < settleStartAt){
      const dt = (now - startAt) / 1000;
      currentOffset = startOffset - speed * dt;
      reelInner.style.transform = `translateY(${currentOffset}px)`;
      reelRAF = requestAnimationFrame(tick);
      return;
    }

    // ê°ì† êµ¬ê°„
    const p = Math.min(1, (now - settleStartAt) / settleMs);
    const e = easeOutCubic(p);

    // ê°ì† ì‹œì‘ offset
    const dtSpin = spinMs / 1000;
    const offsetAtSettleStart = startOffset - speed * dtSpin;

    currentOffset = offsetAtSettleStart + (desired - offsetAtSettleStart) * e;
    reelInner.style.transform = `translateY(${currentOffset}px)`;

    if (p >= 1){
      reelRunning = false;
      reelRAF = null;
      onWin(winnerIndex);
      return;
    }

    reelRAF = requestAnimationFrame(tick);
  }

  reelRAF = requestAnimationFrame(tick);
}

function spawnFireworks(container){
  container.innerHTML = "";
  container.style.display = "block";

  const colors = [
    "radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(35,224,107,.95), rgba(35,224,107,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(255,59,48,.95), rgba(255,59,48,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(255,214,10,.95), rgba(255,214,10,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(10,132,255,.95), rgba(10,132,255,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(175,82,222,.95), rgba(175,82,222,.2) 45%, rgba(0,0,0,.25) 100%)",
  ];

  const count = 18;
  for (let i=0;i<count;i++){
    const p = document.createElement("div");
    p.className = "particle";
    const angle = (Math.PI * 2) * (i / count) + (Math.random()*0.25);
    const dist = 80 + Math.random()*80;
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;

    p.style.setProperty("--dx", `${dx}px`);
    p.style.setProperty("--dy", `${dy}px`);
    p.style.background = colors[i % colors.length];
    p.style.animation = `burst ${700 + Math.random()*450}ms ease-out forwards`;
    p.style.animationDelay = `${Math.random()*80}ms`;

    container.appendChild(p);
  }

  // ìë™ ìˆ¨ê¹€
  setTimeout(() => {
    container.style.display = "none";
    container.innerHTML = "";
  }, OVERLAY_SHOW_AFTER_WIN_MS);
}

function onWin(winnerIndex){
  const resultText = rouletteItems[winnerIndex];

  // âœ… í­ì£½
  spawnFireworks(fwLeft);
  spawnFireworks(fwRight);

  // TTS(ì›í•˜ë©´ ë©˜íŠ¸ ë°”ê¿”ì¤˜ë„ ë¨)
  speakDiva(`í¬ë¡œë¦¬ ê¶ ì¤€ë¹„ ì™„ë£Œ!  ${resultText}!  ì‹œë™, ê±°ëŠ”ì¤‘!`);

  // âœ… í­ì£½ ì ê¹ í›„ ì„œì„œíˆ ì‚¬ë¼ì§
  winFadeTimer = setTimeout(() => {
    rouletteOverlay.style.opacity = "0";
  }, OVERLAY_SHOW_AFTER_WIN_MS);

  winHideTimer = setTimeout(() => {
    rouletteOverlay.style.display = "none";
    rouletteOverlay.style.opacity = "1";
  }, OVERLAY_SHOW_AFTER_WIN_MS + FADE_AFTER_WIN_MS);
}

function startRouletteSpin(){
  stopRouletteIfRunning();

  rouletteOverlay.style.display = "block";
  rouletteOverlay.style.opacity = "1";

  rouletteWrap.classList.remove("pop");
  void rouletteWrap.offsetWidth;
  rouletteWrap.classList.add("pop");

  // ë ˆë²„/ë¦´ ì´ˆê¸°í™”
  leverRod.classList.remove("pullDown","returnUp");
  buildReel();

  // âœ… 10ì´ˆ ëŒ€ê¸° í›„ ë ˆë²„ 1ì´ˆ ë‚´ë ¤ê° â†’ ë‚´ë ¤ê°€ë©´ 30ì´ˆ ë¦´ íšŒì „
  const winnerIndex = pickWinner();

  startDelayTimer = setTimeout(() => {
    leverRod.classList.add("pullDown");
    leverClickPattern(); // ë”¸ê¹ë”¸ê¹

    // ë ˆë²„ ë‚´ë ¤ê°€ìë§ˆì ë¦´ ì‹œì‘
    startReelSpinAndStopOn(winnerIndex);

    // ë ˆë²„ëŠ” ì‚´ì§ ëŠ¦ê²Œ ë³µê·€(ë³´ê¸° ì¢‹ê²Œ)
    leverReturnTimer = setTimeout(() => {
      leverRod.classList.remove("pullDown");
      leverRod.classList.add("returnUp");
      setTimeout(() => leverRod.classList.remove("returnUp"), 560);
    }, LEVER_PULL_MS + 220);

  }, WAIT_BEFORE_PULL_MS);
}

function stopRouletteIfRunning(){
  if (startDelayTimer){ clearTimeout(startDelayTimer); startDelayTimer = null; }
  if (leverReturnTimer){ clearTimeout(leverReturnTimer); leverReturnTimer = null; }
  if (winFadeTimer){ clearTimeout(winFadeTimer); winFadeTimer = null; }
  if (winHideTimer){ clearTimeout(winHideTimer); winHideTimer = null; }

  if (reelRAF){ cancelAnimationFrame(reelRAF); reelRAF = null; }
  reelRunning = false;

  fwLeft.style.display = "none"; fwLeft.innerHTML = "";
  fwRight.style.display = "none"; fwRight.innerHTML = "";

  rouletteOverlay.style.display = "none";
  rouletteOverlay.style.opacity = "1";

  leverRod.classList.remove("pullDown","returnUp");
}
</script>
</body>
</html>
