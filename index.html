<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Porori HUD</title>

<style>
html,body{ margin:0; padding:0; background:transparent; overflow:hidden; }

#widget{
  position:fixed;
  left:0; right:0; bottom:0;
  height:700px;
  pointer-events:none;
}

/* ===== 왼쪽 THIS (2배) ===== */
#leftWrap{
  position:absolute;
  left:16px;
  bottom:16px;
  transform-origin:left bottom;
  transform:scale(2);
  z-index:10;
}
#leftImg{ height:110px; width:auto; display:block; }

/* ===== 중앙 궁 게이지 ===== */
#center{
  position:absolute;
  left:50%;
  bottom:16px;
  height:110px;
  width:auto;
  transform-origin:center bottom;
  transform:translateX(-50%) scale(2.25);
  z-index:5;
}
#ultOn{
  position:absolute;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  height:240px;
  width:auto;
  display:none;
  z-index:50;
}

/* ===== MENTAL ===== */
#mentalWrap{
  position:absolute;
  left:120px;
  bottom:62px;
  z-index:999;
}

#mentalLabel{
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 14px;
  letter-spacing: 1px;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
  margin: 0 0 4px 0;
  user-select: none;
  line-height: 1;
}

/* 바: (왼쪽 2칸 + 아래 1칸) + 가로 0.625 */
#mentalBar{
  display:flex;
  gap:3px;
  padding:5px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.30);
  backdrop-filter: blur(2px);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transform-origin:left top;
  transform: translate(-26px, 6px) scaleX(0.625);
}

.mentalSeg{
  width:10px;
  height:14px;
  border-radius:4px;
  background:#20d070;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
}
.mentalSeg.off{
  background:#f2f2f2;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}
</style>
</head>

<body>
<div id="widget">
  <div id="leftWrap">
    <img id="leftImg" src="./THIS.png" alt="THIS"/>
    <div id="mentalWrap">
      <div id="mentalLabel">MENTAL</div>
      <div id="mentalBar"></div>
    </div>
  </div>

  <img id="center" src="./ow_thick_000.png" alt="Gauge"/>
  <img id="ultOn" src="./On.gif" alt="On"/>
</div>

<script>
/* ===============================
   OW 궁 루프
   - 0→100 (30초/칸)
   - 100% 후 20초 대기
   - On.gif 10분 재생
   - 끝나면 0%로 리셋 후 반복
================================ */
const OW_INTERVAL_MS = 30000;
const ON_DELAY_MS = 20000;
const ON_DURATION_MS = 10 * 60 * 1000;

const centerImg = document.getElementById("center");
const ultOnImg  = document.getElementById("ultOn");

let owValue = 0;
let state = "charging";
let owTimer = null;
let onDelayTimer = null;
let onDurationTimer = null;

const pad3 = n => String(n).padStart(3,"0");
const owPath = n => `./ow_thick_${pad3(n)}.png`;

// preload
for (let i=0;i<=100;i++){
  const im = new Image();
  im.src = owPath(i);
}

function setOW(n){
  owValue = Math.max(0, Math.min(100, n));
  centerImg.src = owPath(owValue) + "?v=" + Date.now();
}

function showOn(){
  ultOnImg.style.display = "block";
  ultOnImg.src = "./On.gif?v=" + Date.now(); // GIF 재시작
}
function hideOn(){
  ultOnImg.style.display = "none";
}

function startCharging(){
  state = "charging";
  hideOn();
  setOW(0);

  clearInterval(owTimer);
  clearTimeout(onDelayTimer);
  clearTimeout(onDurationTimer);

  owTimer = setInterval(() => {
    if (state !== "charging") return;

    if (owValue < 100) setOW(owValue + 1);

    if (owValue >= 100) {
      state = "waitingOn";

      onDelayTimer = setTimeout(() => {
        if (state !== "waitingOn") return;

        state = "onPlaying";
        showOn();

        onDurationTimer = setTimeout(() => {
          // 10분 끝 -> 다시 0부터
          startCharging();
        }, ON_DURATION_MS);

      }, ON_DELAY_MS);
    }
  }, OW_INTERVAL_MS);
}

startCharging();

/* ===============================
   MENTAL 게이지
================================ */
const MENTAL_TOTAL = 20;
const MENTAL_INTERVAL_MS = 10 * 60 * 1000;
let mentalOn = MENTAL_TOTAL;

const mentalBar = document.getElementById("mentalBar");
const mentalSegs = [];

for (let i=0;i<MENTAL_TOTAL;i++){
  const seg = document.createElement("div");
  seg.className = "mentalSeg";
  mentalBar.appendChild(seg);
  mentalSegs.push(seg);
}

function getMentalColor(n){
  if (n >= 16) return "#20d070";
  if (n >= 12) return "#9BEA4A";
  if (n >= 8)  return "#D9B400";
  if (n >= 4)  return "#FF8A1E";
  return "#FF3B30";
}

function renderMental(){
  const c = getMentalColor(mentalOn);
  for (let i=0;i<MENTAL_TOTAL;i++){
    const on = i < mentalOn;
    mentalSegs[i].classList.toggle("off", !on);
    mentalSegs[i].style.backgroundColor = on ? c : "";
  }
}

function tickMental(){
  if (mentalOn > 0) mentalOn -= 1;
  else mentalOn = MENTAL_TOTAL;
  renderMental();
}

renderMental();
setInterval(tickMental, MENTAL_INTERVAL_MS);
</script>
</body>
</html>
