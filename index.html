<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Porori HUD</title>

<style>
html,body{ margin:0; padding:0; background:transparent; overflow:hidden; }
#widget{
  position:fixed; left:0; right:0; bottom:0;
  height:900px;
  pointer-events:none;
}

/* ===== ÏôºÏ™Ω THIS (2Î∞∞) ===== */
#leftWrap{
  position:absolute; left:16px; bottom:16px;
  transform-origin:left bottom;
  transform:scale(2);
  z-index:10;
}
#leftImg{ height:110px; width:auto; display:block; }

/* ===== Ï§ëÏïô OW Í∂Å Í≤åÏù¥ÏßÄ (scale 2.25) ===== */
#center{
  position:absolute; left:50%; bottom:16px;
  height:110px; width:auto;
  transform-origin:center bottom;
  transform:translateX(-50%) scale(2.25);
  z-index:5;
  display:block;
}

/* ===== On.gif (Ï§ëÏïô ÏúÑ) ===== */
#ultOn{
  position:absolute; left:50%; bottom:16px;
  transform:translateX(-50%);
  height:240px; width:auto;
  display:none;
  z-index:50;
  filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
}

/* ===== MENTAL ===== */
#mentalWrap{ position:absolute; left:120px; bottom:62px; z-index:999; }
#mentalLabel{
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 14px;
  letter-spacing: 1px;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
  margin: 0 0 4px 0;
  user-select: none;
  line-height: 1;
}
#mentalBar{
  display:flex; gap:3px;
  padding:5px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.30);
  backdrop-filter: blur(2px);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transform-origin:left top;
  transform: translate(-26px, 6px) scaleX(0.625);
}
.mentalSeg{
  width:10px; height:14px;
  border-radius:4px;
  background:#20d070;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
}
.mentalSeg.off{
  background:#f2f2f2;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}

/* =========================================================
   üé∞ Î†àÎ≤Ñ Ïò§Î≤ÑÎ†àÏù¥
========================================================= */
#rouletteOverlay{
  position:absolute;
  inset:0;
  display:none;
  z-index:200;
  pointer-events:none;
  opacity:1;
  transition: opacity 1.2s ease;
}
#rouletteOverlay.bg{
  background:
    radial-gradient(circle at 50% 40%, rgba(0,0,0,.32), rgba(0,0,0,.14) 55%, rgba(0,0,0,0) 78%);
}

#rouletteWrap{
  position:absolute;
  left:50%;
  top:44%;
  transform:translate(-50%, -50%);
  width:620px;
  height:620px;
}

#rouletteGlow{
  position:absolute;
  inset:-48px;
  border-radius: 999px;
  background: radial-gradient(circle, rgba(255,255,255,.14), rgba(0,0,0,0) 70%);
  filter: blur(2px);
  z-index:-1;
}

/* ‚úÖ ÌÉÄÏù¥ÌãÄ: "Î£∞Î†õ" Í≤ÄÏ†ï / "START!" Ï¥àÎ°ù / "ÎãπÍ≤®Ïöî!" Îπ®Í∞ï */
#rouletteTitle{
  position:absolute;
  left:50%;
  top:-86px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 40px;
  letter-spacing: 1px;
  text-shadow: 0 10px 30px rgba(0,0,0,.55), 0 0 18px rgba(255,255,255,.18);
  white-space:nowrap;
  display:flex;
  align-items:baseline;
  gap:12px;
}
#rouletteTitle .r{
  color: rgba(0,0,0,.90);
  text-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 10px rgba(255,255,255,.12);
}
#rouletteTitle .s{
  color: #23e06b;
  text-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 16px rgba(35,224,107,.40);
}

#rouletteSub{
  position:absolute;
  left:50%;
  top:-26px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 28px;
  letter-spacing: 1px;
  color: #ff3b30;
  text-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 18px rgba(255,59,48,.28);
  white-space:nowrap;
}

/* =========================
   üé∞ ÏïÑÏºÄÏù¥Îìú Ïä¨Î°ØÎ®∏Ïã†(Îçî ÌôîÎ†§ÌïòÍ≤å)
========================= */
#leverMachine{
  width:620px;
  height:620px;
  position:relative;
}

/* ÎÑ§Ïò® ÌÖåÎëêÎ¶¨ ÎßÅ */
#neonRing{
  position:absolute;
  left:50%;
  top:54%;
  transform:translate(-50%,-50%);
  width:590px;
  height:430px;
  border-radius: 46px;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%),
    rgba(0,0,0,.12);
  box-shadow:
    0 40px 110px rgba(0,0,0,.55),
    0 0 36px rgba(35,224,107,.20),
    0 0 26px rgba(10,132,255,.12),
    inset 0 0 0 2px rgba(255,255,255,.10);
}

#arcadeCabinet{
  position:absolute;
  left:50%;
  top:54%;
  transform:translate(-50%,-50%);
  width:560px;
  height:400px;
  border-radius: 40px;
  background:
    radial-gradient(circle at 35% 20%, rgba(255,255,255,.22), rgba(255,255,255,0) 58%),
    linear-gradient(to bottom, rgba(32,32,32,.95), rgba(10,10,10,.96));
  box-shadow:
    0 34px 95px rgba(0,0,0,.58),
    inset 0 0 0 2px rgba(255,255,255,.12),
    inset 0 0 0 12px rgba(0,0,0,.25);
  overflow:hidden;
}

#arcadeBezel{
  position:absolute;
  inset:18px;
  border-radius: 30px;
  background:
    radial-gradient(circle at 50% 0%, rgba(255,255,255,.10), rgba(255,255,255,0) 55%),
    linear-gradient(to bottom, rgba(255,255,255,.07), rgba(255,255,255,0)),
    rgba(0,0,0,.28);
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,.12),
    inset 0 0 0 12px rgba(0,0,0,.22);
}

/* ÏÉÅÎã® ÎßàÌÄ¥(LED) */
#marquee{
  position:absolute;
  left:50%;
  top:24px;
  transform:translateX(-50%);
  width:420px;
  height:64px;
  border-radius: 18px;
  background:
    radial-gradient(circle at 50% 25%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%),
    linear-gradient(to bottom, rgba(35,224,107,.22), rgba(10,132,255,.10));
  box-shadow:
    0 16px 45px rgba(0,0,0,.45),
    inset 0 0 0 2px rgba(255,255,255,.14),
    0 0 18px rgba(35,224,107,.20);
  overflow:hidden;
}
#marqueeText{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 26px;
  letter-spacing: 1px;
  color: rgba(255,255,255,.96);
  text-shadow: 0 10px 25px rgba(0,0,0,.55);
}
#marqueeDots{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  opacity:.95;
}
.dot{
  width:10px; height:10px; border-radius:999px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.12) 50%, rgba(0,0,0,.30) 100%);
  box-shadow: 0 0 14px rgba(35,224,107,.18), 0 10px 18px rgba(0,0,0,.35);
  animation: dotBlink 1.3s infinite ease-in-out;
}
.dot:nth-child(2){ animation-delay:.12s; }
.dot:nth-child(3){ animation-delay:.24s; }
.dot:nth-child(4){ animation-delay:.36s; }
.dot:nth-child(5){ animation-delay:.48s; }
.dot:nth-child(6){ animation-delay:.60s; }
.dot:nth-child(7){ animation-delay:.72s; }
.dot:nth-child(8){ animation-delay:.84s; }
.dot:nth-child(9){ animation-delay:.96s; }
.dot:nth-child(10){ animation-delay:1.08s; }

@keyframes dotBlink{
  0%,100%{ filter:brightness(1); opacity:.75; }
  50%{ filter:brightness(1.55); opacity:1; }
}

/* Î¶¥(Í∏ÄÏî® ÎèåÏïÑÍ∞ÄÎäî Ï∞Ω) */
#reelWindow{
  position:absolute;
  left:50%;
  top:56%;
  transform:translate(-56%,-50%);
  width:360px;
  height:168px;
  border-radius: 22px;
  background: rgba(0,0,0,.62);
  box-shadow:
    0 18px 55px rgba(0,0,0,.48),
    inset 0 0 0 2px rgba(255,255,255,.16),
    inset 0 0 0 12px rgba(0,0,0,.30);
  overflow:hidden;
}

#reelScanline{
  position:absolute;
  inset:0;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,.05) 0px,
    rgba(255,255,255,.05) 2px,
    rgba(0,0,0,0) 7px,
    rgba(0,0,0,0) 14px
  );
  mix-blend-mode: overlay;
  opacity:.26;
  pointer-events:none;
}

#reelHighlight{
  position:absolute;
  left:14px; right:14px;
  top:50%;
  transform:translateY(-50%);
  height:64px;
  border-radius: 16px;
  box-shadow:
    inset 0 0 0 2px rgba(35,224,107,.40),
    0 0 22px rgba(35,224,107,.24);
  background: linear-gradient(to bottom, rgba(35,224,107,.12), rgba(0,0,0,0));
  pointer-events:none;
}

#reelClip{
  position:absolute;
  inset:14px;
  border-radius: 16px;
  overflow:hidden;
}

#reelInner{
  position:absolute;
  left:0; top:0; right:0;
  will-change: transform;
}

.reelItem{
  height:64px;               /* JS ITEM_HÏôÄ ÎèôÏùº */
  display:flex;
  align-items:center;
  justify-content:center;
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 34px;
  letter-spacing: 1px;
  color: rgba(255,255,255,.98);
  text-shadow: 0 12px 28px rgba(0,0,0,.70);
  white-space:nowrap;
  padding:0 14px;
  box-sizing:border-box;
}

/* ÎãπÏ≤® ÌëúÏãú(Î¶¥ Ï∞Ω ÏïÑÎûò, 1Î∂Ñ Ïú†ÏßÄ) */
#winBanner{
  position:absolute;
  left:50%;
  top:calc(56% + 130px);
  transform:translateX(-56%);
  width:360px;
  min-height:56px;
  padding:12px 14px;
  box-sizing:border-box;
  border-radius: 18px;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.16), rgba(255,255,255,0) 55%),
    rgba(0,0,0,.58);
  box-shadow:
    0 18px 55px rgba(0,0,0,.40),
    inset 0 0 0 2px rgba(255,255,255,.16),
    0 0 26px rgba(35,224,107,.14);
  display:none;

  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 22px;
  letter-spacing: .5px;
  color: rgba(255,255,255,.96);
  text-shadow: 0 10px 25px rgba(0,0,0,.60);

  /* ‚úÖ Í∏∏Ïñ¥ÎèÑ Ï§ÑÎ∞îÍøà/ÏûòÎ¶º Î∞©ÏßÄ */
  white-space: normal;
  word-break: keep-all;
  overflow-wrap: anywhere;
  text-align:center;
}

/* ÏÇ¨Ïù¥Îìú ÎùºÏù¥Ìä∏ */
#sideLights{
  position:absolute;
  left:22px;
  top:120px;
  bottom:28px;
  width:50px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  opacity:.96;
}
.lightDot{
  width:18px; height:18px;
  border-radius:999px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.15) 45%, rgba(0,0,0,.35) 100%);
  box-shadow: 0 10px 20px rgba(0,0,0,.35), 0 0 18px rgba(35,224,107,.16);
  margin-left:14px;
  animation: blink 1.6s infinite ease-in-out;
}
.lightDot:nth-child(2){ animation-delay:.2s; }
.lightDot:nth-child(3){ animation-delay:.4s; }
.lightDot:nth-child(4){ animation-delay:.6s; }
.lightDot:nth-child(5){ animation-delay:.8s; }
.lightDot:nth-child(6){ animation-delay:1.0s; }
.lightDot:nth-child(7){ animation-delay:1.2s; }
.lightDot:nth-child(8){ animation-delay:1.4s; }

@keyframes blink{
  0%,100%{ filter:brightness(1); opacity:.82; }
  50%{ filter:brightness(1.45); opacity:1; }
}

/* Î†àÎ≤Ñ(Îçî Ïä§Î¨¥Ïä§) */
#leverAssembly{
  position:absolute;
  right:38px;
  top:58%;
  transform:translateY(-50%);
  width:130px;
  height:320px;
  filter: drop-shadow(0 18px 28px rgba(0,0,0,.45));
}
#leverTrack{
  position:absolute;
  left:50%;
  top:18px;
  transform:translateX(-50%);
  width:30px;
  height:280px;
  border-radius: 999px;
  background:
    linear-gradient(to bottom, rgba(255,255,255,.22), rgba(255,255,255,.04)),
    rgba(0,0,0,.25);
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,.10),
    inset 0 0 0 10px rgba(0,0,0,.20);
}

#leverRod{
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  width:70px;
  height:320px;
  transform-origin: 50% 0%;
  will-change: transform;
}
#leverRod::before{
  content:"";
  position:absolute;
  left:50%;
  top:32px;
  transform:translateX(-50%);
  width:12px;
  height:220px;
  border-radius: 999px;
  background: linear-gradient(to bottom, rgba(255,255,255,.78), rgba(255,255,255,.18));
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
}
#leverKnob{
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  width:58px;
  height:58px;
  border-radius:999px;
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,.18) 35%, rgba(0,0,0,.30) 100%),
    radial-gradient(circle at 60% 70%, rgba(255,59,48,.70), rgba(255,59,48,0) 62%);
  box-shadow: 0 18px 34px rgba(0,0,0,.48), inset 0 0 0 2px rgba(255,255,255,.22);
}

/* ‚úÖ Ïä§Î¨¥Ïä§: ÎÇ¥Î†§Í∞à ÎïåÎäî ease-in, Ïò¨ÎùºÏò¨ ÎïåÎäî ease-out + ÏÇ¥Ïßù Î∞îÏö¥Ïä§ */
@keyframes leverPullDownSmooth {
  0%   { transform: translateX(-50%) translateY(0) rotate(0deg); }
  20%  { transform: translateX(-50%) translateY(30px) rotate(2deg); }
  55%  { transform: translateX(-50%) translateY(165px) rotate(10deg); }
  75%  { transform: translateX(-50%) translateY(175px) rotate(11deg); }
  100% { transform: translateX(-50%) translateY(170px) rotate(10deg); }
}
@keyframes leverReturnUpSmooth {
  0%   { transform: translateX(-50%) translateY(170px) rotate(10deg); }
  70%  { transform: translateX(-50%) translateY(-8px) rotate(-1.2deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
}
#leverRod.pullDown{ animation: leverPullDownSmooth 1000ms cubic-bezier(.18,.92,.24,1) forwards; }
#leverRod.returnUp{ animation: leverReturnUpSmooth 700ms cubic-bezier(.2,.8,.2,1) forwards; }

/* Ìè≠Ï£Ω(ÏñëÏòÜ) */
.fireworks{
  position:absolute;
  top:54%;
  transform:translateY(-50%);
  width:260px;
  height:260px;
  pointer-events:none;
  display:none;
  z-index:5;
}
#fwLeft{ left:-52px; }
#fwRight{ right:-52px; }

.particle{
  position:absolute;
  left:50%; top:50%;
  width:10px; height:10px;
  border-radius:999px;
  transform:translate(-50%,-50%);
  opacity:0;
}

@keyframes burst {
  0%   { transform:translate(-50%,-50%) scale(0.55); opacity:0; }
  12%  { opacity:1; }
  100% { transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1); opacity:0; }
}

/* Ìåù */
@keyframes divaPop {
  0%   { transform:translate(-50%, -50%) scale(1); }
  35%  { transform:translate(-50%, -50%) scale(1.02); }
  70%  { transform:translate(-50%, -50%) scale(0.995); }
  100% { transform:translate(-50%, -50%) scale(1); }
}
#rouletteWrap.pop { animation: divaPop 600ms ease; }
</style>
</head>

<body>
<div id="widget">

  <!-- ÏôºÏ™Ω THIS + MENTAL -->
  <div id="leftWrap">
    <img id="leftImg" src="./THIS.png" alt="THIS"/>
    <div id="mentalWrap">
      <div id="mentalLabel">MENTAL</div>
      <div id="mentalBar"></div>
    </div>
  </div>

  <!-- Ï§ëÏïô OW Í≤åÏù¥ÏßÄ -->
  <img id="center" src="./ow_thick_000.png" alt="Gauge"/>

  <!-- On.gif -->
  <img id="ultOn" src="./On.gif" alt="On"/>

  <!-- üé∞ Î†àÎ≤Ñ Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="rouletteOverlay" class="bg">
    <div id="rouletteWrap">
      <div id="rouletteGlow"></div>

      <div id="rouletteTitle">
        <span class="r">Î£∞Î†õ</span>
        <span class="s">START!</span>
      </div>
      <div id="rouletteSub">ÎãπÍ≤®Ïöî!</div>

      <div id="leverMachine">
        <!-- Ìè≠Ï£Ω -->
        <div id="fwLeft" class="fireworks"></div>
        <div id="fwRight" class="fireworks"></div>

        <!-- ÎÑ§Ïò® ÎßÅ -->
        <div id="neonRing"></div>

        <!-- Î≥∏Ï≤¥ -->
        <div id="arcadeCabinet">
          <div id="arcadeBezel"></div>

          <div id="marquee">
            <div id="marqueeDots">
              <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
              <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <div id="marqueeText">SLOT EVENT</div>
          </div>

          <div id="sideLights" aria-hidden="true">
            <div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div>
            <div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div><div class="lightDot"></div>
          </div>

          <!-- Î¶¥ Ï∞Ω -->
          <div id="reelWindow">
            <div id="reelClip">
              <div id="reelInner"></div>
            </div>
            <div id="reelHighlight"></div>
            <div id="reelScanline"></div>
          </div>

          <!-- ÎãπÏ≤® Î∞∞ÎÑà(Í∏ÄÏî® Ïûò Îã¥Í∏∞ÎèÑÎ°ù) -->
          <div id="winBanner"></div>

          <!-- Î†àÎ≤Ñ -->
          <div id="leverAssembly">
            <div id="leverTrack"></div>
            <div id="leverRod">
              <div id="leverKnob"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<script>
/* =========================================================
   üîä "D.Va ÎäêÎÇå" Ïó¨ÏÑ± TTS
========================================================= */
let divaVoice = null;

function chooseDivaVoice(){
  if (!("speechSynthesis" in window)) return null;
  const voices = window.speechSynthesis.getVoices();

  let v =
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko") && /(female|woman|girl)/i.test(x.name)) ||
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko") && /(Ïó¨|Ïó¨ÏÑ±|ÏÜåÎÖÄ|yuna|sora|seo|ji)/i.test(x.name)) ||
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko")) ||
    voices.find(x => /(female|woman|girl)/i.test(x.name)) ||
    null;

  return v || null;
}

function ensureVoiceReady(){
  try{
    if (!("speechSynthesis" in window)) return;
    const tryPick = () => { divaVoice = chooseDivaVoice(); };
    tryPick();
    if (!divaVoice){
      window.speechSynthesis.onvoiceschanged = () => {
        divaVoice = chooseDivaVoice();
      };
    }
  }catch(e){}
}
ensureVoiceReady();

function speakDiva(text){
  try{
    if (!("speechSynthesis" in window)) return;
    const synth = window.speechSynthesis;
    synth.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ko-KR";
    u.rate = 1.18;
    u.pitch = 1.45;
    u.volume = 1.0;

    if (!divaVoice) divaVoice = chooseDivaVoice();
    if (divaVoice) u.voice = divaVoice;

    synth.speak(u);
  }catch(e){}
}

/* =========================================================
   üéµ Ïä¨Î°Ø Î†àÎ≤Ñ "Îî∏ÍπçÎî∏Íπç" ÏÇ¨Ïö¥Îìú (WebAudio)
========================================================= */
let audioCtx = null;

function getAudioCtx(){
  if (!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    audioCtx = new AC();
  }
  return audioCtx;
}

function unlockAudio(){
  const ctx = getAudioCtx();
  if (!ctx) return;
  if (ctx.state === "suspended"){
    ctx.resume().catch(()=>{});
  }
}
window.addEventListener("pointerdown", unlockAudio, { once:true });
window.addEventListener("keydown", unlockAudio, { once:true });

function clickSound({ t=0, pitch=900, dur=0.035, gain=0.22 } = {}){
  const ctx = getAudioCtx();
  if (!ctx) return;
  if (ctx.state === "suspended") return;

  const now = ctx.currentTime + t;

  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type = "square";
  o.frequency.setValueAtTime(pitch, now);
  o.frequency.exponentialRampToValueAtTime(Math.max(80, pitch*0.65), now + dur);

  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(gain, now + 0.003);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

  o.connect(g).connect(ctx.destination);
  o.start(now);
  o.stop(now + dur);

  const bufferSize = Math.floor(ctx.sampleRate * 0.02);
  const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++){
    const decay = Math.exp(-i / (bufferSize * 0.18));
    data[i] = (Math.random()*2 - 1) * 0.22 * decay;
  }
  const noise = ctx.createBufferSource();
  const ng = ctx.createGain();
  noise.buffer = buffer;
  ng.gain.setValueAtTime(0.0001, now);
  ng.gain.exponentialRampToValueAtTime(gain*0.55, now + 0.001);
  ng.gain.exponentialRampToValueAtTime(0.0001, now + 0.02);
  noise.connect(ng).connect(ctx.destination);
  noise.start(now);
}

function leverClickPattern(){
  clickSound({ t: 0.00, pitch: 1050, gain: 0.18, dur: 0.030 });
  clickSound({ t: 0.12, pitch: 980,  gain: 0.17, dur: 0.030 });
  clickSound({ t: 0.24, pitch: 900,  gain: 0.17, dur: 0.032 });
  clickSound({ t: 0.62, pitch: 720,  gain: 0.26, dur: 0.048 });
  clickSound({ t: 0.92, pitch: 860,  gain: 0.14, dur: 0.028 });
}

/* =========================================================
   ‚úÖ OW Í∂Å Î£®ÌîÑ (Í≤πÏπ® Î∞©ÏßÄ Ìè¨Ìï®)
========================================================= */
const OW_INTERVAL_MS = 1_000;
const HOLD_100_MS    = 30_000;
const ON_DURATION_MS = 10 * 60 * 1000;

const centerImg = document.getElementById("center");
const ultOnImg  = document.getElementById("ultOn");

const pad3  = (n) => String(n).padStart(3,"0");
const owPath = (n) => `./ow_thick_${pad3(n)}.png`;

for (let i=0;i<=100;i++){
  const im = new Image();
  im.src = owPath(i);
}

let owValue = 0;
let chargingTimer = null;
let holdTimer = null;
let onTimer = null;

function setOW(n){
  owValue = Math.max(0, Math.min(100, n));
  centerImg.src = owPath(owValue) + "?v=" + Date.now();
}
function showOn(){
  ultOnImg.style.display = "block";
  ultOnImg.src = "./On.gif?v=" + Date.now();
}
function hideOn(){ ultOnImg.style.display = "none"; }

function clearOWTimers(){
  if (chargingTimer){ clearInterval(chargingTimer); chargingTimer = null; }
  if (holdTimer){ clearTimeout(holdTimer); holdTimer = null; }
  if (onTimer){ clearTimeout(onTimer); onTimer = null; }
}

function startOWLoop(){
  clearOWTimers();
  owValue = 0;
  hideOn();
  centerImg.style.visibility = "visible";
  setOW(0);

  chargingTimer = setInterval(() => {
    if (owValue < 100) setOW(owValue + 1);

    if (owValue >= 100){
      clearInterval(chargingTimer);
      chargingTimer = null;

      holdTimer = setTimeout(() => {
        centerImg.style.visibility = "hidden";
        showOn();
        startRouletteSpin();

        onTimer = setTimeout(() => {
          hideOn();
          stopRouletteIfRunning();
          centerImg.style.visibility = "visible";
          startOWLoop();
        }, ON_DURATION_MS);

      }, HOLD_100_MS);
    }
  }, OW_INTERVAL_MS);
}
startOWLoop();

/* =========================================================
   MENTAL Í≤åÏù¥ÏßÄ
========================================================= */
const MENTAL_TOTAL = 20;
const MENTAL_INTERVAL_MS = 10 * 60 * 1000;
let mentalOn = MENTAL_TOTAL;

const mentalBar = document.getElementById("mentalBar");
const mentalSegs = [];
for (let i=0;i<MENTAL_TOTAL;i++){
  const seg = document.createElement("div");
  seg.className = "mentalSeg";
  mentalBar.appendChild(seg);
  mentalSegs.push(seg);
}

function getMentalColor(n){
  if (n >= 16) return "#20d070";
  if (n >= 12) return "#9BEA4A";
  if (n >= 8)  return "#D9B400";
  if (n >= 4)  return "#FF8A1E";
  return "#FF3B30";
}
function renderMental(){
  const c = getMentalColor(mentalOn);
  for (let i=0;i<MENTAL_TOTAL;i++){
    const on = i < mentalOn;
    mentalSegs[i].classList.toggle("off", !on);
    mentalSegs[i].style.backgroundColor = on ? c : "";
  }
}
function tickMental(){
  if (mentalOn > 0) mentalOn -= 1;
  else mentalOn = MENTAL_TOTAL;
  renderMental();
}
renderMental();
setInterval(tickMental, MENTAL_INTERVAL_MS);

/* =========================================================
   üé∞ Ïä¨Î°Ø Ïó∞Ï∂ú (ÏÜçÎèÑ ÌîÑÎ°úÌïÑ + 1Î∂Ñ ÎãπÏ≤®ÌëúÏãú)
   ÏöîÍµ¨:
   - Ï≤òÏùå ÏïÑÏ£º Ï≤úÏ≤úÌûà
   - Ï§ëÍ∞Ñ: 0.5Ï¥àÎãπ 1Í∞úÏî©(=500ms/Í∞ú)
   - ÎÅù: Ï≤úÏ≤úÌûà Î©àÏ∂îÎ©∞ ÎãπÏ≤® ÏÑ†ÌÉù
========================================================= */
const rouletteItems = [
  "Í≥®Î∞òÎåÑÏä§",
  "Ìè¨ÏºìÎ™¨ÎåÑÏä§",
  "ÌÑ∞ÎØ∏ÎÑêÎåÑÏä§",
  "Í¥ÄÏ†úÌÉëÎåÑÏä§",
  "Ïï†Íµê ÌÉÄÏûÑ",
  "ÏÇ¨Ïø†ÎûÄÎ≥¥ÎåÑÏä§",
];

const rouletteOverlay = document.getElementById("rouletteOverlay");
const rouletteWrap = document.getElementById("rouletteWrap");
const leverRod = document.getElementById("leverRod");
const reelInner = document.getElementById("reelInner");

const fwLeft = document.getElementById("fwLeft");
const fwRight = document.getElementById("fwRight");

const winBanner = document.getElementById("winBanner");

const WAIT_BEFORE_PULL_MS = 10_000;
const LEVER_PULL_MS = 1_000;

/* Î¶¥ Îã®Í≥Ñ ÏãúÍ∞Ñ */
const PHASE1_MS = 6_000;   // ÏïÑÏ£º Ï≤úÏ≤úÌûà Í∞ÄÏÜç
const PHASE2_MS = 18_000;  // Ï§ëÍ∞Ñ: 0.5Ï¥à/Í∞úÎ°ú ÏïàÏ†ï
const PHASE3_MS = 6_000;   // Ï≤úÏ≤úÌûà Í∞êÏÜç + ÎãπÏ≤® Í≥†Ï†ï
const TOTAL_SPIN_MS = PHASE1_MS + PHASE2_MS + PHASE3_MS;

const WIN_SHOW_MS = 60_000;        // ‚úÖ ÎãπÏ≤® ÌëúÏãú 1Î∂Ñ
const FADE_AFTER_WIN_MS = 1_200;   // ÌéòÏù¥Îìú

const ITEM_H = 64; // .reelItem height
let cycleH = rouletteItems.length * ITEM_H;

let startDelayTimer = null;
let leverReturnTimer = null;
let winHideTimer = null;
let winFadeTimer = null;

let reelRAF = null;
let reelRunning = false;

let currentOffset = 0;

function buildReel(){
  const repeats = 26; // Í∏∏Í≤å
  const all = [];
  for (let r=0;r<repeats;r++){
    for (let i=0;i<rouletteItems.length;i++){
      all.push(rouletteItems[i]);
    }
  }
  reelInner.innerHTML = all.map(t => `<div class="reelItem">${t}</div>`).join("");
  cycleH = rouletteItems.length * ITEM_H;
  currentOffset = 0;
  reelInner.style.transform = `translateY(${currentOffset}px)`;
}
buildReel();

function pickWinner(){
  return Math.floor(Math.random() * rouletteItems.length);
}

function lerp(a,b,t){ return a + (b-a)*t; }
function easeInOutCubic(x){
  return x < 0.5 ? 4*x*x*x : 1 - Math.pow(-2*x + 2, 3)/2;
}
function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

/* "Î≥¥Ïù¥Îäî Ìï≠Î™© Ïù∏Îç±Ïä§" Í≥ÑÏÇ∞Ïö©: Î¶¥ ÎÇ¥Î∂Ä transform Í∏∞Ï§Ä */
function getCurrentIndexFromOffset(off){
  // offÎäî ÏùåÏàòÎ°ú Ï§ÑÏñ¥ÎìúÎäî Î∞©Ìñ•(Ïª®ÌÖêÏ∏†Í∞Ä ÏúÑÎ°ú ÏõÄÏßÅÏûÑ) Í∞ÄÏ†ï
  const normalized = ((-off % cycleH) + cycleH) % cycleH; // 0..cycleH
  return Math.floor(normalized / ITEM_H) % rouletteItems.length;
}

/* ÎãπÏ≤® Ïù∏Îç±Ïä§Î•º ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï§ëÏïôÏóê ÎßûÏ∂îÎäî Î™©Ìëú offset ÎßåÎì§Í∏∞ */
function computeWinnerOffsetNear(currentOff, winnerIndex){
  const centerY = 50; // Ï§ëÏïô Í∞êÍ∞Å Î≥¥Ï†ï(Ï°∞Í∏à Îçî ÏïàÏ†ïÏ†ÅÏúºÎ°ú)
  const targetInCycle = winnerIndex * ITEM_H;
  let desired = - (targetInCycle - centerY);

  // desiredÎ•º currentOffÎ≥¥Îã§ Ï∂©Î∂ÑÌûà ÏûëÏùÄ(Îçî ÎßéÏù¥ ÌöåÏ†ÑÌïú) Í∞íÏúºÎ°ú ÎÇ¥Î¶º
  while (desired > currentOff - cycleH) desired -= cycleH;
  // Ï∂îÍ∞Ä ÌöåÏ†Ñ(Îçî ÎèåÎã§ Î©àÏ∂îÎäî ÎäêÎÇå)
  desired -= cycleH * 5;
  return desired;
}

/* Îã®Í≥ÑÎ≥Ñ ‚ÄúÏïÑÏù¥ÌÖúÎãπ ÏãúÍ∞Ñ(ms)‚Äù ÌîÑÎ°úÌïÑ */
function msPerItemProfile(t){
  // t: 0..TOTAL_SPIN_MS
  // Phase1: 900ms/Í∞ú -> 500ms/Í∞úÎ°ú Ï≤úÏ≤úÌûà Í∞ÄÏÜç
  if (t < PHASE1_MS){
    const p = t / PHASE1_MS;
    return lerp(900, 500, easeInOutCubic(p));
  }
  // Phase2: Í≥†Ï†ï 500ms/Í∞ú
  if (t < PHASE1_MS + PHASE2_MS){
    return 500;
  }
  // Phase3: 500ms/Í∞ú -> 1100ms/Í∞úÎ°ú Ï≤úÏ≤úÌûà Í∞êÏÜç
  const tt = t - (PHASE1_MS + PHASE2_MS);
  const p = Math.min(1, tt / PHASE3_MS);
  return lerp(500, 1100, easeOutCubic(p));
}

function startReelSpinWithProfileAndStop(winnerIndex){
  if (reelRAF) cancelAnimationFrame(reelRAF);
  reelRunning = true;

  const startAt = performance.now();
  const startOff = currentOffset;

  // "ÏïÑÏù¥ÌÖúÏù¥ Î∞îÎÄåÎäî Îã®ÏúÑ"Î°ú ÏõÄÏßÅÏù¥Í≤å (ÎÑàÍ∞Ä ÏõêÌïòÎäî ‚Äò0.5Ï¥àÎãπ ÌïúÍ∞úÏî© Î≥¥Ïù¥Í≤å‚Äô ÎäêÎÇå)
  let lastStepAt = startAt;
  let off = startOff;

  // Phase3ÏóêÏÑú Î™©Ìëú ÏúÑÏπòÎ°ú Ïä§ÎÉÖ/Î≥¥Í∞ÑÌïòÍ∏∞ ÏúÑÌïú Ï§ÄÎπÑ
  let finalTargetOff = null;
  let finalStartOff = null;
  let finalStartAt = null;

  function tick(now){
    if (!reelRunning) return;

    const elapsed = now - startAt;

    if (elapsed >= TOTAL_SPIN_MS){
      // Ï¢ÖÎ£å: Ï†ïÌôïÌûà ÎãπÏ≤® ÏúÑÏπòÎ°ú Í≥†Ï†ï
      if (finalTargetOff === null){
        finalTargetOff = computeWinnerOffsetNear(off, winnerIndex);
        finalStartOff = off;
        finalStartAt = now;
      }
      const settleMs = 900; // ÎßàÏßÄÎßâ Í≥†Ï†ï Î≥¥Í∞Ñ(Î∂ÄÎìúÎüΩÍ≤å)
      const p = Math.min(1, (now - finalStartAt) / settleMs);
      const e = easeOutCubic(p);
      off = finalStartOff + (finalTargetOff - finalStartOff) * e;

      currentOffset = off;
      reelInner.style.transform = `translateY(${currentOffset}px)`;

      if (p >= 1){
        reelRunning = false;
        reelRAF = null;
        onWin(winnerIndex);
        return;
      }
      reelRAF = requestAnimationFrame(tick);
      return;
    }

    // ÌîÑÎ°úÌïÑ Í∏∞Î∞òÏúºÎ°ú ‚ÄúÎã§Ïùå Ïä§ÌÖù(=Îã§Ïùå ÏïÑÏù¥ÌÖú)‚ÄùÎ°ú ÎÑòÏñ¥Í∞à ÏãúÍ∞Ñ Í≥ÑÏÇ∞
    const msPerItem = msPerItemProfile(elapsed);

    if (now - lastStepAt >= msPerItem){
      // Ìïú Ïä§ÌÖùÎßàÎã§ ITEM_HÎßåÌÅº Ïù¥Îèô(ÏïÑÎûòÎ°ú Íµ¥Îü¨Í∞ÄÎäî ÎäêÎÇå)
      const steps = Math.floor((now - lastStepAt) / msPerItem);
      lastStepAt += steps * msPerItem;

      off -= ITEM_H * steps;
      currentOffset = off;
      reelInner.style.transform = `translateY(${currentOffset}px)`;
    }

    reelRAF = requestAnimationFrame(tick);
  }

  reelRAF = requestAnimationFrame(tick);
}

function spawnFireworks(container){
  container.innerHTML = "";
  container.style.display = "block";

  const colors = [
    "radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(35,224,107,.95), rgba(35,224,107,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(255,59,48,.95), rgba(255,59,48,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(255,214,10,.95), rgba(255,214,10,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(10,132,255,.95), rgba(10,132,255,.2) 45%, rgba(0,0,0,.25) 100%)",
    "radial-gradient(circle at 30% 30%, rgba(175,82,222,.95), rgba(175,82,222,.2) 45%, rgba(0,0,0,.25) 100%)",
  ];

  const count = 26;
  for (let i=0;i<count;i++){
    const p = document.createElement("div");
    p.className = "particle";
    const angle = (Math.PI * 2) * (i / count) + (Math.random()*0.25);
    const dist = 90 + Math.random()*95;
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;

    p.style.setProperty("--dx", `${dx}px`);
    p.style.setProperty("--dy", `${dy}px`);
    p.style.background = colors[i % colors.length];
    p.style.boxShadow = "0 12px 26px rgba(0,0,0,.35)";
    p.style.animation = `burst ${760 + Math.random()*520}ms ease-out forwards`;
    p.style.animationDelay = `${Math.random()*90}ms`;

    container.appendChild(p);
  }

  // Í≥ÑÏÜç Î≥¥Ïó¨Îëò ÌïÑÏöî ÏóÜÏñ¥ÏÑú Î™á Ï¥à ÌõÑ Ïà®ÍπÄ(Î∞∞ÎÑàÎäî 1Î∂Ñ Ïú†ÏßÄ)
  setTimeout(() => {
    container.style.display = "none";
    container.innerHTML = "";
  }, 2600);
}

function onWin(winnerIndex){
  const resultText = rouletteItems[winnerIndex];

  // Ìè≠Ï£Ω
  spawnFireworks(fwLeft);
  spawnFireworks(fwRight);

  // ‚úÖ ÎãπÏ≤® Î∞∞ÎÑà(Í∏ÄÏî® Ïûò Îã¥Í∏∞Í≤å)
  winBanner.style.display = "block";
  winBanner.textContent = `üéâ ÎãπÏ≤®!  ${resultText} üéâ`;

  speakDiva(`Ìè¨Î°úÎ¶¨ Í∂Å Ï§ÄÎπÑ ÏôÑÎ£å!  ${resultText}!  ÏãúÎèô, Í±∞ÎäîÏ§ë!`);

  // 1Î∂Ñ Îí§ ÌéòÏù¥Îìú ÌõÑ Ïà®ÍπÄ
  winFadeTimer = setTimeout(() => {
    rouletteOverlay.style.opacity = "0";
  }, WIN_SHOW_MS);

  winHideTimer = setTimeout(() => {
    rouletteOverlay.style.display = "none";
    rouletteOverlay.style.opacity = "1";
    winBanner.style.display = "none";
    winBanner.textContent = "";
  }, WIN_SHOW_MS + FADE_AFTER_WIN_MS);
}

function startRouletteSpin(){
  stopRouletteIfRunning();

  rouletteOverlay.style.display = "block";
  rouletteOverlay.style.opacity = "1";

  rouletteWrap.classList.remove("pop");
  void rouletteWrap.offsetWidth;
  rouletteWrap.classList.add("pop");

  // Ï¥àÍ∏∞Ìôî
  leverRod.classList.remove("pullDown","returnUp");
  winBanner.style.display = "none";
  winBanner.textContent = "";

  buildReel();

  const winnerIndex = pickWinner();

  // 10Ï¥à ÎåÄÍ∏∞ ÌõÑ Î†àÎ≤Ñ ÎÇ¥Î†§Í∞ê(Ïä§Î¨¥Ïä§) + Î¶¥ ÏãúÏûë
  startDelayTimer = setTimeout(() => {
    leverRod.classList.add("pullDown");
    leverClickPattern();

    // Î†àÎ≤ÑÍ∞Ä ÎÇ¥Î†§Í∞ÄÎäî ÎèôÏïàÏùÄ Î¶¥ÏùÑ ÏïÑÏ£º Ï≤úÏ≤úÌûà ÏãúÏûë (ÌîÑÎ°úÌïÑÏù¥ ÏïåÏïÑÏÑú Ï≤òÎ¶¨)
    startReelSpinWithProfileAndStop(winnerIndex);

    // Î†àÎ≤Ñ Î≥µÍ∑ÄÎèÑ Îçî ÏûêÏó∞Ïä§ÎüΩÍ≤å
    leverReturnTimer = setTimeout(() => {
      leverRod.classList.remove("pullDown");
      leverRod.classList.add("returnUp");
      setTimeout(() => leverRod.classList.remove("returnUp"), 720);
    }, LEVER_PULL_MS + 260);

  }, WAIT_BEFORE_PULL_MS);
}

function stopRouletteIfRunning(){
  if (startDelayTimer){ clearTimeout(startDelayTimer); startDelayTimer = null; }
  if (leverReturnTimer){ clearTimeout(leverReturnTimer); leverReturnTimer = null; }
  if (winHideTimer){ clearTimeout(winHideTimer); winHideTimer = null; }
  if (winFadeTimer){ clearTimeout(winFadeTimer); winFadeTimer = null; }

  if (reelRAF){ cancelAnimationFrame(reelRAF); reelRAF = null; }
  reelRunning = false;

  fwLeft.style.display = "none"; fwLeft.innerHTML = "";
  fwRight.style.display = "none"; fwRight.innerHTML = "";

  winBanner.style.display = "none";
  winBanner.textContent = "";

  rouletteOverlay.style.display = "none";
  rouletteOverlay.style.opacity = "1";

  leverRod.classList.remove("pullDown","returnUp");
}
</script>
</body>
</html>
