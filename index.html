<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Porori HUD</title>

<style>
html,body{ margin:0; padding:0; background:transparent; overflow:hidden; }
#widget{
  position:fixed; left:0; right:0; bottom:0;
  height:900px;
  pointer-events:none;
}

/* ===== ÏôºÏ™Ω THIS (2Î∞∞) ===== */
#leftWrap{
  position:absolute; left:16px; bottom:16px;
  transform-origin:left bottom;
  transform:scale(2);
  z-index:10;
}
#leftImg{ height:110px; width:auto; display:block; }

/* ===== Ï§ëÏïô OW Í∂Å Í≤åÏù¥ÏßÄ (scale 2.25) ===== */
#center{
  position:absolute; left:50%; bottom:16px;
  height:110px; width:auto;
  transform-origin:center bottom;
  transform:translateX(-50%) scale(2.25);
  z-index:5;
  display:block;
}

/* ===== On.gif (Ï§ëÏïô ÏúÑ) ===== */
#ultOn{
  position:absolute; left:50%; bottom:16px;
  transform:translateX(-50%);
  height:240px; width:auto;
  display:none;
  z-index:50;
  filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
}

/* ===== MENTAL ===== */
#mentalWrap{ position:absolute; left:120px; bottom:62px; z-index:999; }
#mentalLabel{
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 14px;
  letter-spacing: 1px;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,.65);
  margin: 0 0 4px 0;
  user-select: none;
  line-height: 1;
}
#mentalBar{
  display:flex; gap:3px;
  padding:5px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.30);
  backdrop-filter: blur(2px);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transform-origin:left top;
  transform: translate(-26px, 6px) scaleX(0.625);
}
.mentalSeg{
  width:10px; height:14px;
  border-radius:4px;
  background:#20d070;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
}
.mentalSeg.off{
  background:#f2f2f2;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
}

/* =========================================================
   üé° Î£∞Î†õ Ïò§Î≤ÑÎ†àÏù¥
   - ÌöåÏ†Ñ 30Ï¥à
   - Í≤∞Í≥º 30Ï¥à Î≥¥Ïó¨Ï§å
   - ÏÑúÏÑúÌûà ÏÇ¨ÎùºÏßê (fade-out)
========================================================= */
#rouletteOverlay{
  position:absolute;
  inset:0;
  display:none;
  z-index:200;
  pointer-events:none;
  opacity:1;
  transition: opacity 2.0s ease;
}
#rouletteOverlay.bg{
  background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.28), rgba(0,0,0,.12) 55%, rgba(0,0,0,0) 78%);
}

#rouletteWrap{
  position:absolute;
  left:50%;
  top:44%;
  transform:translate(-50%, -50%);
  width:460px;
  height:460px;
}

#rouletteTitle{
  position:absolute;
  left:50%;
  top:-64px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 28px;
  letter-spacing: 1px;
  color: rgba(255,255,255,.95);
  text-shadow: 0 10px 30px rgba(0,0,0,.55), 0 0 18px rgba(255,255,255,.25);
  white-space:nowrap;
}

#rouletteHint{
  position:absolute;
  left:50%;
  top:-28px;
  transform:translateX(-50%);
  font-family: Arial, sans-serif;
  font-weight: 800;
  font-size: 13px;
  letter-spacing: .6px;
  color: rgba(255,255,255,.85);
  text-shadow: 0 6px 18px rgba(0,0,0,.5);
  white-space:nowrap;
}

#rouletteCanvas{
  width:460px;
  height:460px;
  display:block;
  filter: drop-shadow(0 20px 55px rgba(0,0,0,.45));
}

/* Ìè¨Ïù∏ÌÑ∞(ÏúÑÏ™Ω) */
#roulettePointer{
  position:absolute;
  left:50%;
  top:-8px;
  transform:translateX(-50%);
  width:0; height:0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-bottom: 28px solid rgba(255,255,255,.95);
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.55));
}

/* Í≤∞Í≥º Ïπ¥Îìú */
#rouletteResult{
  position:absolute;
  left:50%;
  bottom:-84px;
  transform:translateX(-50%);
  min-width: 360px;
  padding: 14px 18px;
  border-radius: 16px;

  font-family: Arial, sans-serif;
  font-weight: 900;
  font-size: 18px;
  letter-spacing: .5px;
  color: rgba(255,255,255,.95);
  text-align:center;

  background: linear-gradient(180deg, rgba(0,255,255,.18), rgba(255,0,200,.12));
  box-shadow: 0 18px 48px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.18);
  text-shadow: 0 10px 25px rgba(0,0,0,.55);
  display:none;
}

#rouletteGlow{
  position:absolute;
  inset:-30px;
  border-radius: 999px;
  background: radial-gradient(circle, rgba(0,255,255,.16), rgba(255,0,200,.10) 35%, rgba(0,0,0,0) 70%);
  filter: blur(2px);
  z-index:-1;
}

/* (ÏòµÏÖò) ÏïÑÏ£º ÏÇ¥Ïßù ÌùîÎì§Î¶¨Îäî ÎäêÎÇå */
@keyframes divaPop {
  0%   { transform:translate(-50%, -50%) scale(1); }
  35%  { transform:translate(-50%, -50%) scale(1.02); }
  70%  { transform:translate(-50%, -50%) scale(0.995); }
  100% { transform:translate(-50%, -50%) scale(1); }
}
#rouletteWrap.pop { animation: divaPop 600ms ease; }
</style>
</head>

<body>
<div id="widget">

  <!-- ÏôºÏ™Ω THIS + MENTAL -->
  <div id="leftWrap">
    <img id="leftImg" src="./THIS.png" alt="THIS"/>
    <div id="mentalWrap">
      <div id="mentalLabel">MENTAL</div>
      <div id="mentalBar"></div>
    </div>
  </div>

  <!-- Ï§ëÏïô OW Í≤åÏù¥ÏßÄ -->
  <img id="center" src="./ow_thick_000.png" alt="Gauge"/>

  <!-- On.gif -->
  <img id="ultOn" src="./On.gif" alt="On"/>

  <!-- üé° Î£∞Î†õ Ïò§Î≤ÑÎ†àÏù¥ -->
  <div id="rouletteOverlay" class="bg">
    <div id="rouletteWrap">
      <div id="rouletteGlow"></div>
      <div id="rouletteTitle">Î£∞Î†õ START!</div>
      <div id="rouletteHint">30Ï¥à ÌöåÏ†Ñ ‚Üí 30Ï¥à Í≤∞Í≥º + ÏùåÏÑ± ‚Üí ÏÑúÏÑúÌûà ÏÇ¨ÎùºÏßê</div>
      <div id="roulettePointer"></div>
      <canvas id="rouletteCanvas" width="460" height="460"></canvas>
      <div id="rouletteResult"></div>
    </div>
  </div>

</div>

<script>
/* =========================================================
   üîä "D.Va ÎäêÎÇå" Ïó¨ÏÑ± TTS (Í∞ÄÎä•Ìïú Î≤îÏúÑÏóêÏÑú)
   - ÌïúÍµ≠Ïñ¥ ÏùåÏÑ± Ï§ë "Ïó¨ÏÑ±/ÏÜåÎÖÄ" ÌÇ§ÏõåÎìú Ïö∞ÏÑ† ÏÑ†ÌÉù
   - pitch(ÌÜ§) ÎÜíÍ≤å, rate(ÏÜçÎèÑ) ÏÇ¥Ïßù Îπ†Î•¥Í≤å
   - ÎîîÎ∞îÏ≤òÎüº ÌÜ°ÌÜ° ÌäÄÎäî ÎäêÎÇåÏúºÎ°ú Î¨∏Ïû• ÏÇ¨Ïù¥ ÏßßÏùÄ ÏâºÎèÑ ÎÑ£Ïùå
========================================================= */
let divaVoice = null;

function chooseDivaVoice(){
  if (!("speechSynthesis" in window)) return null;
  const voices = window.speechSynthesis.getVoices();

  // 1) ko + Ïó¨ÏÑ± ÌÇ§ÏõåÎìú (Ïù¥Î¶ÑÏóê female/woman/girl Îì± Ìè¨Ìï®)
  let v =
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko") && /(female|woman|girl)/i.test(x.name)) ||

    // 2) ko + ÌùîÌïú Ïó¨ÏÑ± Ïù¥Î¶Ñ/ÌëúÍ∏∞ (ÌôòÍ≤ΩÎßàÎã§ Îã§Î¶Ñ)
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko") && /(Ïó¨|Ïó¨ÏÑ±|ÏÜåÎÖÄ|ÏßÄÏùÄ|ÏÑúÏó∞|Ïú†ÎÇò|sora|yuna|jiy|ji|sun|seo)/i.test(x.name)) ||

    // 3) ko ÏïÑÎ¨¥Í±∞ÎÇò
    voices.find(x => (x.lang||"").toLowerCase().startsWith("ko")) ||

    // 4) ÎßàÏßÄÎßâ fallback: ÏïÑÎ¨¥ female
    voices.find(x => /(female|woman|girl)/i.test(x.name)) ||

    null;

  return v || null;
}

function ensureVoiceReady(){
  try{
    if (!("speechSynthesis" in window)) return;

    // iOS/ÌÅ¨Î°¨ ÏùºÎ∂ÄÎäî getVoicesÍ∞Ä ÎπÑÏñ¥ÏûàÎã§Í∞Ä Ïù¥Î≤§Ìä∏ ÌõÑ Ï±ÑÏõåÏßê
    const tryPick = () => { divaVoice = chooseDivaVoice(); };
    tryPick();

    if (!divaVoice){
      window.speechSynthesis.onvoiceschanged = () => {
        divaVoice = chooseDivaVoice();
      };
    }
  }catch(e){}
}

ensureVoiceReady();

function speakDiva(text){
  try{
    if (!("speechSynthesis" in window)) return;

    const synth = window.speechSynthesis;
    synth.cancel();

    const u = new SpeechSynthesisUtterance(text);
    u.lang = "ko-KR";

    // üéÄ ÎîîÎ∞î ÎäêÎÇå ÌäúÎãù (Îçî Í≥ºÍ∞ê)
    u.rate = 1.18;   // Ï¢Ä Îçî Îπ†Î•¥Í≤å
    u.pitch = 1.45;  // Îçî ÏÜåÎÖÄ ÎäêÎÇå
    u.volume = 1.0;

    // ÏÑ†ÌÉùÎêú ÏùåÏÑ± Ï†ÅÏö©(Í∞ÄÎä•ÌïòÎ©¥)
    if (!divaVoice) divaVoice = chooseDivaVoice();
    if (divaVoice) u.voice = divaVoice;

    synth.speak(u);
  }catch(e){
    // ÏúÑÏ†Ø/Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±ÖÏúºÎ°ú ÎßâÌûê Ïàò ÏûàÏùå
  }
}

/* =========================================================
   ‚úÖ OW Í∂Å Î£®ÌîÑ
   - 0‚Üí100 (50Ï¥à/Ïπ∏)
   - 100% ÎèÑÎã¨ ÌõÑ 30Ï¥à ÎèôÏïà "100% Í≤åÏù¥ÏßÄÎßå" ÌëúÏãú
   - Í∑∏ Ïù¥ÌõÑ On.gif 10Î∂Ñ Ïû¨ÏÉù
   - ÎÅùÎÇòÎ©¥ 0%Î°ú Î¶¨ÏÖã ÌõÑ Î∞òÎ≥µ
   + On.gif ÏãúÏûë ÏàúÍ∞Ñ üé° Î£∞Î†õ 30Ï¥à Ïä§ÌïÄ
     ‚Üí Í≤∞Í≥º 30Ï¥à ÌëúÏãú(ÏùåÏÑ±)
     ‚Üí fade-out Ï¢ÖÎ£å
========================================================= */
const OW_INTERVAL_MS = 50_000;         // 50Ï¥à/1%
const HOLD_100_MS    = 30_000;         // 100% Ïú†ÏßÄ 30Ï¥à
const ON_DURATION_MS = 10 * 60 * 1000; // On 10Î∂Ñ

const centerImg = document.getElementById("center");
const ultOnImg  = document.getElementById("ultOn");

const pad3  = (n) => String(n).padStart(3,"0");
const owPath = (n) => `./ow_thick_${pad3(n)}.png`;

// preload
for (let i=0;i<=100;i++){
  const im = new Image();
  im.src = owPath(i);
}

let owValue = 0;
let chargingTimer = null;
let holdTimer = null;
let onTimer = null;

function setOW(n){
  owValue = Math.max(0, Math.min(100, n));
  centerImg.src = owPath(owValue) + "?v=" + Date.now();
}
function showOn(){
  ultOnImg.style.display = "block";
  ultOnImg.src = "./On.gif?v=" + Date.now();
}
function hideOn(){ ultOnImg.style.display = "none"; }

function clearOWTimers(){
  if (chargingTimer){ clearInterval(chargingTimer); chargingTimer = null; }
  if (holdTimer){ clearTimeout(holdTimer); holdTimer = null; }
  if (onTimer){ clearTimeout(onTimer); onTimer = null; }
}

function startOWLoop(){
  clearOWTimers();

  owValue = 0;
  hideOn();
  setOW(0);

  chargingTimer = setInterval(() => {
    if (owValue < 100){
      setOW(owValue + 1);
    }

    if (owValue >= 100){
      clearInterval(chargingTimer);
      chargingTimer = null;

      holdTimer = setTimeout(() => {
        showOn();
        startRouletteSpin(); // On ÏãúÏûëÍ≥º ÎèôÏãúÏóê Î£∞Î†õ ÏãúÏûë

        onTimer = setTimeout(() => {
          hideOn();
          stopRouletteIfRunning();
          startOWLoop();
        }, ON_DURATION_MS);

      }, HOLD_100_MS);
    }
  }, OW_INTERVAL_MS);
}
startOWLoop();

/* =========================================================
   MENTAL Í≤åÏù¥ÏßÄ
========================================================= */
const MENTAL_TOTAL = 20;
const MENTAL_INTERVAL_MS = 10 * 60 * 1000;
let mentalOn = MENTAL_TOTAL;

const mentalBar = document.getElementById("mentalBar");
const mentalSegs = [];
for (let i=0;i<MENTAL_TOTAL;i++){
  const seg = document.createElement("div");
  seg.className = "mentalSeg";
  mentalBar.appendChild(seg);
  mentalSegs.push(seg);
}

function getMentalColor(n){
  if (n >= 16) return "#20d070";
  if (n >= 12) return "#9BEA4A";
  if (n >= 8)  return "#D9B400";
  if (n >= 4)  return "#FF8A1E";
  return "#FF3B30";
}
function renderMental(){
  const c = getMentalColor(mentalOn);
  for (let i=0;i<MENTAL_TOTAL;i++){
    const on = i < mentalOn;
    mentalSegs[i].classList.toggle("off", !on);
    mentalSegs[i].style.backgroundColor = on ? c : "";
  }
}
function tickMental(){
  if (mentalOn > 0) mentalOn -= 1;
  else mentalOn = MENTAL_TOTAL;
  renderMental();
}
renderMental();
setInterval(tickMental, MENTAL_INTERVAL_MS);

/* =========================================================
   üé° Î£∞Î†õ (30Ï¥à ÌöåÏ†Ñ ‚Üí Í≤∞Í≥º 30Ï¥à + ÏùåÏÑ± ‚Üí fade-out)
========================================================= */
const rouletteItems = [
  "Í≥®Î∞òÎåÑÏä§",
  "Ìè¨ÏºìÎ™¨ÎåÑÏä§",
  "ÌÑ∞ÎØ∏ÎÑêÎåÑÏä§",
  "Í¥ÄÏ†úÌÉë ÎåÑÏä§",
  "1Î∂ÑÍ∞Ñ Ïï†Íµê ÌÉÄÏûÑ",
  "ÏÇ¨Ïø†ÎûÄÎ≥¥ ÎåÑÏä§",
];

const rouletteOverlay = document.getElementById("rouletteOverlay");
const rouletteWrap = document.getElementById("rouletteWrap");
const rouletteCanvas  = document.getElementById("rouletteCanvas");
const rctx = rouletteCanvas.getContext("2d");
const rouletteResult = document.getElementById("rouletteResult");

const ROULETTE_SPIN_MS = 30_000;
const ROULETTE_SHOW_MS = 30_000;
const ROULETTE_FADE_MS = 2_000;

let rouletteRAF = null;
let rouletteRunning = false;

let currentAngle = 0;
let targetAngle = 0;
let winnerIndex = 0;

let rouletteFadeTimer = null;
let rouletteHideTimer = null;

function pickWinner(){
  return Math.floor(Math.random() * rouletteItems.length);
}

function drawWheel(angle){
  const w = rouletteCanvas.width;
  const h = rouletteCanvas.height;
  const cx = w/2, cy = h/2;
  const R = Math.min(w,h)*0.43;

  rctx.clearRect(0,0,w,h);

  const glow = rctx.createRadialGradient(cx,cy,R*0.2, cx,cy,R*1.15);
  glow.addColorStop(0, "rgba(0,255,255,0.18)");
  glow.addColorStop(0.5, "rgba(255,0,200,0.12)");
  glow.addColorStop(1, "rgba(0,0,0,0)");
  rctx.fillStyle = glow;
  rctx.beginPath();
  rctx.arc(cx,cy,R*1.15,0,Math.PI*2);
  rctx.fill();

  rctx.save();
  rctx.translate(cx,cy);
  rctx.rotate(angle);

  const n = rouletteItems.length;
  const slice = (Math.PI*2)/n;

  for (let i=0;i<n;i++){
    const a0 = i*slice;
    const a1 = a0 + slice;

    rctx.beginPath();
    rctx.moveTo(0,0);
    rctx.arc(0,0,R,a0,a1);
    rctx.closePath();
    rctx.fillStyle = (i%2===0) ? "rgba(0,255,255,0.22)" : "rgba(255,0,200,0.16)";
    rctx.fill();

    rctx.strokeStyle = "rgba(255,255,255,0.22)";
    rctx.lineWidth = 2;
    rctx.stroke();

    const mid = (a0+a1)/2;
    rctx.save();
    rctx.rotate(mid);
    rctx.translate(R*0.62, 0);
    rctx.rotate(Math.PI/2);
    rctx.font = "900 18px Arial";
    rctx.fillStyle = "rgba(255,255,255,0.95)";
    rctx.shadowColor = "rgba(0,0,0,0.55)";
    rctx.shadowBlur = 10;
    rctx.textAlign = "center";
    rctx.textBaseline = "middle";
    rctx.fillText(rouletteItems[i], 0, 0);
    rctx.restore();
  }

  rctx.beginPath();
  rctx.arc(0,0,R*0.22,0,Math.PI*2);
  rctx.fillStyle = "rgba(10,10,14,0.70)";
  rctx.fill();
  rctx.strokeStyle = "rgba(255,255,255,0.22)";
  rctx.lineWidth = 2;
  rctx.stroke();

  rctx.font = "900 16px Arial";
  rctx.fillStyle = "rgba(255,255,255,0.92)";
  rctx.shadowColor = "rgba(0,0,0,0.55)";
  rctx.shadowBlur = 12;
  rctx.textAlign = "center";
  rctx.textBaseline = "middle";
  rctx.fillText("SPIN", 0, 0);

  rctx.restore();

  rctx.beginPath();
  rctx.arc(cx,cy,R,0,Math.PI*2);
  rctx.strokeStyle = "rgba(255,255,255,0.26)";
  rctx.lineWidth = 3;
  rctx.stroke();
}

function easeOutCubic(x){ return 1 - Math.pow(1-x, 3); }

function startRouletteSpin(){
  stopRouletteIfRunning();

  rouletteOverlay.style.display = "block";
  rouletteOverlay.style.opacity = "1";
  rouletteResult.style.display = "none";
  rouletteResult.textContent = "";

  // Ìåù Ïï†ÎãàÎ©îÏù¥ÏÖò(ÎîîÎ∞î ÎäêÎÇå)
  rouletteWrap.classList.remove("pop");
  void rouletteWrap.offsetWidth;
  rouletteWrap.classList.add("pop");

  rouletteRunning = true;
  const startAt = performance.now();

  winnerIndex = pickWinner();

  const n = rouletteItems.length;
  const slice = (Math.PI*2)/n;
  const winnerMid = (winnerIndex + 0.5) * slice;

  const baseTarget = -winnerMid;
  const extraTurns = 20 + Math.floor(Math.random()*6); // Ï°∞Í∏à Îçî "Ìò∏Îì§Í∞ë" ÎèåÍ∏∞
  const startAngle = currentAngle;
  targetAngle = baseTarget + extraTurns * Math.PI * 2;

  function tick(now){
    if (!rouletteRunning) return;

    const elapsed = now - startAt;
    const p = Math.min(1, elapsed / ROULETTE_SPIN_MS);
    const e = easeOutCubic(p);

    currentAngle = startAngle + (targetAngle - startAngle) * e;
    drawWheel(currentAngle);

    if (p >= 1){
      rouletteRunning = false;
      rouletteRAF = null;

      const resultText = rouletteItems[winnerIndex];

      rouletteResult.textContent = `ÎãπÏ≤®: ${resultText}`;
      rouletteResult.style.display = "block";

      // ‚úÖ ÎîîÎ∞î ÎäêÎÇå Î¨∏Ïû•(ÏßßÏùÄ ÏâºÌëúÎ°ú ÌÜ°ÌÜ°)
      speakDiva(`Ìè¨Î°úÎ¶¨ Í∂Å Ï§ÄÎπÑ ÏôÑÎ£å!  ${resultText}!  ÏãúÎèô, Í±∞ÎäîÏ§ë!`);

      rouletteFadeTimer = setTimeout(() => {
        rouletteOverlay.style.opacity = "0";
      }, ROULETTE_SHOW_MS);

      rouletteHideTimer = setTimeout(() => {
        rouletteOverlay.style.display = "none";
        rouletteOverlay.style.opacity = "1";
      }, ROULETTE_SHOW_MS + ROULETTE_FADE_MS);

      return;
    }

    rouletteRAF = requestAnimationFrame(tick);
  }

  drawWheel(currentAngle);
  rouletteRAF = requestAnimationFrame(tick);
}

function stopRouletteIfRunning(){
  if (rouletteRAF){
    cancelAnimationFrame(rouletteRAF);
    rouletteRAF = null;
  }
  rouletteRunning = false;

  if (rouletteFadeTimer){ clearTimeout(rouletteFadeTimer); rouletteFadeTimer = null; }
  if (rouletteHideTimer){ clearTimeout(rouletteHideTimer); rouletteHideTimer = null; }

  rouletteOverlay.style.display = "none";
  rouletteOverlay.style.opacity = "1";
  rouletteResult.style.display = "none";
}
</script>
</body>
</html>
